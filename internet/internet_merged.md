# 第一章 计算机网络的概念

## 计算机网络的概念 组成 功能 分类

### 概念

计算机网络： 是一个将分散的，具有独立功能的计算机系统，通过通信设备与线路连接起来，由功能完善的软件实现资源共享和信息传递的系统。是一个互联的，自治的计算机集合。

### 功能

1. 数据通信（连通性）

2. 资源共享（硬件，软件，数据）

3. 分布式处理：多台计算机各自承担同一工作任务的不同部分

4. 提高可靠性：替代机

5. 负载均衡

### 组成

组成部分：硬件，软件，协议

工作方式：

1. 边缘部分： 用户直接使用，C/S 方式，P2P方式。 

2. 核心部分：为边缘部分服务。

功能组成：数据通信，资源共享。

1. 通信子网：网络层，数据链路层，物理层，实现数据通信。

2. 资源子网：应用层，表示层，会话层，实现资源共享/数据处理。

![计算机网络的功能组成](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter01/计算机网络的功能组成.jpeg)

### 分类

+ 按分布范围分：广域网WAN，城域网MAN，局域网WAN，个人区域网PAN。

  局域网：广播技术，广域网：交换技术

+ 按使用者分：公用网，专用网

+ 按交换技术分：电路交换，报文交换，分组交换。

+ 按拓扑结构分：总线型，星型，环形，网状型。

+ 按传输技术分：广播式网络：共享公共通信信道。点对点网络：使用分组存储转发和路由选择机制。

## 标准化工作

标准的分类：

法定标准：由权威机构制定的正式的，合法的标准 OSI

事实标准：某些公司的产品在竞争中占据了主流，时间长了这些产品中的协议和技术就成了标准。

### 标准化工作的相关组织

ISO,ITU,IEEE,IETF

## 性能指标

速度，带宽，吞吐量，时延，时延带宽积，往返时间RTT，利用率

### 速率

数据率或称数据传输率或比特率。

**比特bit：** 1/0 单位是位。 1Byte=8bit

速率：连接在计算机网络上的主机在数字信道上传输数据位数的速率。（发送端，接收端）

单位：b/s，kb/s，Mb/s，Gb/s，Tb/s

### 带宽

1. 带宽原本指某个信号具有的**频带宽度**，即最高频率与最低频率之差，单位Hz（模拟信号）

2. 计算机网络中，带宽用来表示网络的通信线路传送数据能力，通常是单位时间内从网络中的某一点到另一点所能通过的最高数据率。单位是比特每秒。
**“网络设备所支持的最高速度”**

链路：链路带宽=1Mb/s，主机在1us内可项链路发1bit数据，传播速率：电磁波1us可传播200m，2*10 8次方m/s

### 吞吐量

单位时间内通过某个网络（或信道，接口）的数据量，单位b/s，kb/s，Mb/s等。

吞吐量受网络的带宽或网络的额定速率限制。

### 时延：

指数据（报文，分组，比特流）从网络（或链路）的一端传送到另一端所需的时间，也叫延迟或迟延，单位是s

时延分为：发送时延（传输时延），传播时延，排队时延，处理时延

1. 发送时延：从发送分组的第一个比特算起，到该分组的最后一个比特发送完毕所需要的时间。

  >**发送时延=数据长度/信道带宽（发送速率）**

2. 传播时延：取决于电磁波传播速度和链路长度。
  >**传播时延=信道长度/电磁波在信道上的传播速率**

3. 排队时延：等待输入/输出链路可用。

4. 处理时延：捡错、找出口

### 时延带宽积

>时延带宽积（bit） = 传播时延（s）* 带宽（b/s）

带宽指的是发送端发送时可以达到的最大数据率，电磁波在信道上传播一定距离所花费的时间。描述信息量/数据量多少。又被称为一比特位单位的链路长度，即某段链路现在有多少比特（容量）

### 往返时延RTT

从发送方发送数据开始，到发送方收到接收方的确认（接收方收到数据后立即发送确认），总共经历的时延。
RTT越大，在**收到确认之前**可以发送的数据越多。

>RTT包括：往返传播时延 = 传播时延*2，以及末端处理时间，一般忽略传播时延。

### 利用率

>信道利用率 = 有数据通过时间 /（有+无）数据通过时间

网络利用率：信道利用率加权平均值

## 分层结构

### 为什么要分层

发送文件前要解决很多工作，比如：

1. 发起通信的计算机必须将数据通信的通路进行激活。

2. 高速网络如何识别目的主机。

3. 发起通信的计算机要查明目的主机是否开机，并且与网络连接正常。

4. 发起通信的计算机要查明对方计算机中文件管理程序是否做好准备工作。

5. 确保差错和意外可以解决。

### 如何分层

（对等）实体之间的协议，接口，服务

基本原则：

1. 各层之间相互独立，每层只实现一种相对独立的功能

2. 每层之间界面自然清晰，易于理解，相互交流尽量少

3. 结构上可以分割开，每层采用最合适的技术来实现。

4. 保持下层对上层的独立性，上层单向使用下层提供的服务。

5. 整个分层结构应该能促进标准化工作

### 分层结构：


![分层结构1](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter01/分层结构1.jpeg)

1. 实体：第n层中的活动元素称为n层实体，同一层实体叫做对等实体

2. 协议：为进行网络中的**对等实体**数据交换而建立的规则，标准或约定称为网络协议。
要规定语法，语义（要完成的功能），同步（规定各种操作的顺序）

3. 接口：访问服务点SAP：上层使用下层服务，下层为上层提供服务的入口

4. 服务：**下层为相邻上层**提供的功能调用（垂直）。

    SDU 服务数据单元：为完成用户所要求的功能而应传送的数据。

    PCI 协议控制信息：控制协议操作的信息。

    PDU 协议数据单元：对等层次之间传送的数据单位。

![分层结构2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter01/分层结构2.jpeg)

### 概念总结

+ 网络体系结构是从功能上描述计算机网络结构

+ 计算机网络体系结构分层结构

+ 每层遵循某个/某些网络协议以完成本层功能

+ 计算机网络体系结构是计算机网络的各层机器协议的集合。

+ 第n层在向n+1层提供服务时，此服务不仅包含第n层本身的功能，还包含由下层服务提供的功能。

+ 仅仅在相邻层间有接口，且所提供服务的具体实现细节对上一层完全屏蔽。

+ 体系结构是抽象的，而实现是指能运行的一些软件和硬件

## OSI参考模型

+ 7层OSI参考模型（法定模型）

+ 4层TCP/IP参考模型（事实标准）

+ 5层体系结构

### ISO/OSI参考模型的由来

按功能分层结构

目的：支持异构网络系统的互联互通。1984：OSI参考模型。

### 七层参考模型

物理层，数据链路层，网络层，传输层，会话层，表示层，应用层

OSI模型层之间有很多重复功能

通信子网（数据通信）：1，2，3 。 资源子网（数据处理）：5，6，7

### 用OSI参考模型解释通信过程

![osi参考模型解释通信过程](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter01/osi参考模型解释通信过程.PNG)

![osi参考模型解释通信过程2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter01/osi参考模型解释通信过程2.PNG)

### **应用层**

所有能和**用户**交互产生网络流量的程序。

典型应用层服务：文件传输（FTP），电子邮件（SMTP），万维网（HTTP）

&nbsp;

### **表示层**

用于处理在两个通信系统中交换信息的表示方式（语法和语义）

+ 功能一：数据格式变换

+ 功能二：数据加密和解密

+ 功能三：数据压缩和恢复

&nbsp;

### **会话层**

向表示层实体/用户进程提供建立连接并在连接上有序地传输数据。这是会话，也是建立同步（SYN）

+ 功能一：建立，管理，终止对话

+ 功能二：使用校验点可使会话在通信失效时从校验点/同步点继续恢复通信，实现数据同步（适用于传输大文件）

&nbsp;

### **传输层**

负责主机中两个进程的通信，即端到端的通信。传输单位是报文段或用户数据报。

+ 功能一：可靠传输，不可靠传输

+ 功能二：差错控制

+ 功能三：流量控制：发送和接收的速度匹配

+ 功能四：复用分用

  复用：多个应用层进程可同时使用下面运输层的服务。

  分用：运输层把收到的信息分别交付给上面应用层中**相应**的进程。

协议：UDP，TCP

&nbsp;


### **网络层（IP层，网际层）**

主要任务是把分组从源端传到目的端，为分组交换网上的不同主机提供通信服务。
网络层传输单位是数据报。

+ 功能一：路由选择（最佳路径）

+ 功能二：流量控制

+ 功能三：差错控制

+ 功能四：拥塞控制

  若所有节点都来不及接受分组，而要丢弃大量分组的话，网络就处于拥塞状态。因此要采取一定措施缓解这种拥塞

主要协议：IP, IPX, ICMP, IGMP, ARP, RARP, OSPF

&nbsp;

### **数据链路层（链路层）**


主要是把网络层传下来的数据报组装成帧。数据链路层/链路层的传输单位是帧。

主要协议：SDLC, HDLC, PPP, STP

+ 功能一：组装成帧：定义帧的开始和结束

+ 功能二：差错控制：帧错+位错

+ 功能三：流量控制

+ 功能四：访问（接入）控制：控制对信道的访问

&nbsp;

### **物理层**

在物理媒体上实现比特流的透明传输。
物理层传输单位是比特。

透明传输：指不管所传输数据是什么样的比特组合，都应当能够在链路上传送。

+ 功能一：定义接口特性。

+ 功能二：定义传输模式：单工，双工，半双工。

  单工：单方向，发送端接收端只能有一个在发送，发送端和接收端被确定。

  半双工：两者都可作为发送端或接收端，但同时只能有一个在发送。

+ 功能三：定义传输速率

+ 功能四：比特同步

+ 功能五：比特编码

  协议：Rj45，802.3

&nbsp;

## TCP/IP模型and五层参考模型

先有协议栈，再根据协议栈形成了分层

### TCP/IP模型

![osi与tcpip模型](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter01/osi与tcpip模型.JPG)

相同点：

1. 都分层

2. 基于独立协议栈的概念

3. 实现**异构网络互联**

不同点：

1. OSI定义三点：服务，协议，接口

2. OSI先出现，参考模型先于协议发明，不偏向特定协议。

3. TCP/IP设计之初就考虑到异构网互联问题，将IP作为重要层次

4. 表格


    | | ISO/OSI参考模型 | TCP/IP模型 |
    | ---- | ---- | ---- |
    | 网络层 | 无连接+ 面向连接| 无连接 |
    | 传输层 | 面向连接 | 无连接+面向连接 |
&nbsp;

**面向连接**分为三个阶段，第一个是建立连接，在此阶段，发出一个建立连接的请求。第二阶段：只有在连接成功建立之后才能开始数据传输。第三阶段：当数据传输完毕释放连接，实现“可靠传输”，而**无连接**没有这么多阶段，直接进行数据传输。

&nbsp;
### 五层参考模型

应用层：支持各种网络应用，FTP, SMTP, HTTP

传输层：进程-进程之间的数据传输 TCP，UDP

网络层：源主机到目的主机的数据分组路由与转发 IP,ICMP,OSPF等

数据链路层：把网络层传下来的数据报组装成帧 Ethernet，PPP

物理层：比特传输

&nbsp;

### 五层参考模型的数据封装与解封装

![五层参考模型的数据封装与解封装](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter01/五层参考模型的数据封装与解封装.jpeg)# 第二章 物理层

## abstract

1. 通信基础

2. 两个公式lim

3. 看图说话

4. 传输介质

5. 物理层设备

## 基本概念

物理层解决如何在连接各种计算机的传输媒体上传输比特流。而不是指具体的传输媒体

主要任务：确定与**传输媒体接口**有关的一些特性 -> 定义标准

1. 机械特性：定义物理连接的特性，规定物理连接时所采用的规格，接口形状，引线数目，引脚数量和排列状况

2. 电气特性：规定传输二进制位时，线路上信号的电压范围，阻抗匹配，传输速率和距离限制等

3. 功能特性：指明某条线上出现的某一电平表示何种意义，接口部件的信号线的用途

4. 规程特性：（过程特性）定义各条物理线路的工作规程和时序关系

## 数据通信基础知识

典型的数据通信模型：

![典型的数据通信模型](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter02/典型的数据通信模型.JPG)

### 相关术语：

通信的目的是传送消息。

数据：传送信息的实体，通常是有意义的符号序列

信号：数据的电气/电磁的表现，是数据在传输过程中的形式----数字信号，离散 / 模拟信号，连续

信源：产生和发送数据的源头

信宿：接受数据的终点。

信道：信号的传输媒介，一般用来表示向某个方向传送信息的介质，因此一条通信线路往往包含一条发送信道和一条接收信道。模拟信号（传送模拟信号）/ 数字信道，有线信道/无线信道

### 三种通信方式

1. 单工通信 只有一个方向的通信而没有反方向的交互，仅需一条信道

2. 半双工通信 通信的双方都可以发送或接收信息，但任何一方都不能同时发送和接收，需要两条信道

3. 双工通信 通信双方可以同时发送和接收信息，需要两条信道

### 两种数据传输方式

串行传输：速度慢，费用低，适合远距离

并行传输：速度快，费用高，适合近距离。常用于计算机内部数据传输。

## 码元，波特，速率，带宽

### 码元

码元是指用一个固定市场的信号波形（数字脉冲），代表不同离散数值的基本波形，是数字通信中数字信号的计量单位，
这个时长内的信号称为k进制码元，而该时长称为**码元宽度**。当码元的离散状态有M个时(M>2)，此时码元为M进制码元

1码元可以携带多个比特的信息量，例如在使用二进制编码时，只有两种不同的码元，一种表示0状态，另一种代表1状态。

4进制码元：离散状态有4个，有4种高低不同的信号波形，00，01，10，11

### 速率，波特，带宽

速率也叫数据率，是指数据的传输速率，表示单位时间内传输的数据量。可以用码元传输速率和信息传输速率表示

1. 码元传输速率：简称码元速率，波形速率，调制速率，符号速率等，他表示**单位时间内数字通信系统所传输的码元个数**，
也可称为脉冲个数或信号变化的次数）单位是波特，1波特表示数字通信系统中每秒传输一个码元，可以是任意进制的，
码元速率和进制数无关：1s传输多少个码元。

2. 信息传输速率：别名信息速率，比特率等等。表示单位时间内数字通信系统传输的**二进制**码元个数，即比特数。单位是比特/秒

关系：若一个码元携带n bit的信息量，则M波特的码元传输速率所对应的信息传输速率为 M*n bit/s

3. 带宽：表示在单位时间内从网络中某一点到另一点所能通过的“最高数据率”，常用来表示网络的通信线路所能传输数据的能力，单位是b/s。

### 练习题
![波特练习题](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter02/波特练习题.JPG)

取对数：16进制码元有 $$\log _{2} 16 = 4$$ 位二进制数 

$\log _{2} 4$


### 总结

系统传输的是比特流，通常比较的是信息传输速率，所以传输十六进制码元的通信系统传输速率较快，如果该系统去传输四进制码元会有更高的码元传输速率

## 奈氏准则和香农定理

### 失真

现实中的信道（带宽受限、有噪声、干扰）

影响失真程度的因素：码元传输速率，信号传输距离，噪声干扰，传输媒体质量。

**信道带宽：** 信道能通过的最高频率和最低频率之差。过高频率：** 码间串扰**，频率太高导致无法区分不同信号之间的波形差异，
接收端收到的信号波形失去了码元之间清晰界限的现象。
过低频率：衰减太快。

### 奈奎斯特定理

or奈氏准则：在理想低通（无噪声，带宽受限）的条件下，为了避免码间串扰，**极限码元传输速率**为2W波特，W是信道带宽，单位是Hz。

区分：极限数据率 2Wlog2 V（b/s）  V：几种码元/码元的离散电平数目

1. 在任何信道中，码元传输的速率是有上限的，若传输速率超过此上限，就会出现严重的码间串扰问题。使接收端对码元的完全正确识别成为不可能。

2. 信道的频带越宽，即能通过的信号高频份量越多，就可以用更高的速率进行码元的有效传输。

3. 奈氏准则 给出了码元传输速率的限制，没有对信息传输速率给出限制

4. 由于码元的传输速度收到奈氏准则的制约，所以要提高数据的传输速率，就必须设法使**每个码元**能携带更多比特的信息量，
这就需要用到多元制的调制方法。

![奈氏定理练习](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter02/奈氏定理练习.PNG)

### 香农定理

噪声存在于所有电子设备和通信信道中，由于噪声随机产生。他的瞬时值有时会很大，因此噪声会使接收端对码元的判决产生错误，
但是噪声的影响是相对的，若信号较强，那么噪声影响相对较小。因此**信噪比**就很重要。

信噪比 = 信号的平均功率/噪声的平均功率，常记为S/N，并用分贝dB作为度量单位、
公式

![香农定理](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter02/香农定理.PNG)

### 推论

在带宽受限且有噪声的信道中，为了不产生误差，信息的数据传输速率有上限值。

1. 信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高。

2. 对一定的传输带宽和一定的信噪比，信息传输速率的上限就确定了。

3. 只要信息的传输速率低于信道的极限传输速率，就一定能找到某种方法来实现无差错的传输。

4. 香农定理得出的为极限信息传输速率，实际信道能达到的传输速率要比它低

5. 从香农定理可以看出，若信道带宽W或信噪比S/N没有上限（不可能），那么信道的极限信息传输速率也没有上限。

### 香农定理，奈氏准则

奈氏准则：避免码间串扰。

香农定理：有噪声条件下的信息传输速率。

## 编码和调制

### 基带信号和宽带信号

信道：信号的传输媒介。一般用来表示向某一个方向传送信息的介质，因此一条通信线路往往包含一条发送信道和一条接收信道。

![基带信号宽带信号](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter02/基带信号宽带信号.JPG)

数据 -> 数字信号：**编码**

数据 -> 模拟信号：**调制**

### 数字数据编码为数字信号

1. 非归零编码 NRZ：高1低0，编码容易实现，没有检错功能，无法判断一个码元的开始和结束。因此收发双方难以保持同步。

2. 曼彻斯特编码：将一个码元分成两个相等的间隔，前一个间隔为低电平后一个间隔为高电平表示码元1，码元0则相反。
也可以采用相反的规定。该编码的特点是在每一个码元的中间出现电平跳变，位中间的跳变既作为时钟信号有作为数据信号，
但他所占的频带宽度是原始的基带宽度的两倍。每一个码元都被调成两个电平，所以数据传输速率只有调制速率的1/2. 

3. 差分曼斯特编码：同1异0，常用于局域网传输，其规则是：若码元为1，则前半个码元的电平与上一个码元的后半个码元电平相同，
若为0则相反。特点是在每个码元的中间都有一次电平的跳转，可以实现自同步，且抗干扰性强于曼彻斯特编码。

4. 归零编码 RZ：信号电平在一个码元之内都要恢复到0的编码

5. 反向不归零编码 NRZI：信号电平反转表示0，信号电平不变表示1

6. 4B/5B编码：比特流中插入额外比特以打破一连串的0或1，编码变为80%

![数字数据编码为数字信号](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter02/数字数据编码为数字信号.JPG)

### 数字数据调制为模拟信号

发送端将数字信号调制为模拟信号：调制，接收端将模拟信号解调为数字信号：解调

![数字数据调制为模拟信号](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter02/数字数据调制为模拟信号.PNG)


习题：某通信链路的波特率是1200Baud，采用4个相位，每个相位有4种振幅的QAM调制技术，则该链路的信息传输速率是多少

（hint：16种信号，16种码元）

### 模拟数据编码为数字信号

一般是数字音频

![模拟数据编码为数字信号](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter02/模拟数据编码为数字信号.JPG)


### 模拟信号调制为模拟信号

转换到更高频率进行传输，频分复用技术以充分利用带宽资源，等

## 传输介质

传输介质/传输媒体/传输媒介：是传输系统中在发送设备和接收设备之间的物理通路。

传输媒体不是物理层。传输媒体在物理层下面，因为物理层是体系结构的第一层，因此有时称传输媒体为0层。
在传输媒体中传输的是信号，但传输媒体并不知道所传输的信号代表什么意思。但物理层规定了电气特性，因此能够识别所传送的比特流。

传输介质分类：

导向性传输介质：电磁波被导向沿着固体媒介（铜线，光纤）传播

非导向性传输介质：自由空间，空气，海水，真空等

### 双绞线

两根采用一定规则并排绞合的，相互绝缘的铜导线组成。绞合可以减少对相邻导线的电磁干扰。

屏蔽双绞线/非屏蔽双绞线：双绞线外加上一个金属丝编织成的屏蔽层。

双绞线价格便宜，是最常用的传输介质之一，在局域网和传统电话网中普遍使用，模拟传输和数字传输都可以使用双绞线，其通信距离一般为十公里到数十公里。距离太远时对于模拟传输，要用放大器放大衰减的信号。对于数字传输，要用中继器将失真的信号整形。

### 同轴电缆

导致铜质芯线，绝缘层，网状编织屏蔽层和塑料外层。

同轴电缆vs双绞线：由于外导体屏蔽层的作用，同轴电缆抗干扰特性比双绞线好，被广泛用于传输较高速率的数据，其传输距离更远，但价格更贵。

### 光纤

光纤通信就是利用光导纤维传递光脉冲来进行通信。有光脉冲表示1，无光脉冲表示0，而可见光的频率大约是10^8 MHz，因此光纤通信系统的带宽远远大于
目前其他各种传输媒体的带宽。

光纤在发送端由光源，可以采用发光二极管或半导体激光器，在电脉冲作用下产生光脉冲，再在接收端用观点二极管做成光检测器，还原光脉冲。

光纤主要有纤芯和包层构成,光波通过纤芯有较低的折射率，当光线从高折射率的介质射向低折射率的介质时，其折射角将大于入射角，因此如果入射角足够大，就会出现全反射，即光线碰到包层的时候就会折射回纤芯，光沿着光纤传输，超低损耗、超远传输

![光纤](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter02/光纤.JPG)


单模光纤，多模光纤

![单模光纤多模光纤](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter02/单模光纤多模光纤.png)

单模光纤几乎相当于直线传播，光纤直径减少到波长

光纤特点：

1. 传输损耗小，中继距离长，对远距离传输特别经济

2. 抗雷电和电磁干扰性好

3. 无串音干扰，保密性好，不易被窃听和截取数据

4. 体积小，重量轻

### 非导向性传输介质

无线电波，信号向所有方向传播：较强穿透能力，可传远距离，广泛用于通信领域（如手机通信）

微波，信号向固定方向传播：微波通信频率较高，频段范围宽，因此数据率很高。地面微博接力通信，卫星通信

红外线、激光，固定方向传播：把传输信号分别转换为各自的信号格式：红外信号and激光信号，再在空间中传播。

## 物理层设备

### 中继器

诞生原因：由于存在损耗，在线路上传输信号功率会衰减，衰减到一定程度时将造成信号失真，因此会导致接收错误。

中继器的功能：对**数字**信号进行**再生**和还原，对衰减的信号进行放大。保持与原数据相同，以增加信号传输的距离，延长网络的长度。

中继器的两端：两端的网络部分是**网段**，而不是子网，适用于完全相同的两类网络的互联，且两个网段速率要相同。
中继器只将任何电缆段上的数据发送到另一端电缆上，他仅作用于信号的电气部分，
并不管数据中是否有错误数据或不适于网段的数据。

两端可连接相同媒体，也可以连接不同媒体。

中继器两端的网段一定是同一个协议（中继器不会存储转发）

5-4-3 规则：网络标准中都对信号的延迟范围做了具体的规定，因而中继器只能在规定的范围内进行，否则会网络故障

5: 最多5个网段

4: 5个网段内最多4个网络设备：中继器/集线器

3：最多三个段可以连接计算机

### 集线器（多口中继器）

再生，放大信号

集线器功能：对信号进行再生放大转发，对衰减信号进行放大，接着转发到其他所有（除输入端口外）出于工作状态的端口上，以增加信号传输的距离，
延长网络长度。不具备信号的定向传送能力。是一个共享式设备

广播，星型拓扑

集线器不能分割冲突，各设备平分带宽。
# 第三章 数据链路层

## abstract 

+ 链路层功能

+ 链路层的两种信道

+ 局域网，广域网

+ 链路层设备

## 数据链路层功能概述

数据链路层的研究思想：加头加尾 给物理层

## 基本概念

结点： 主机、路由器

*链路*：网络中两个结点之间的物理通道，

数据链路：网络中两个结点之间的**逻辑通道**，把实现控制数据传输协议的硬件和软件加到链路上就构成数据链路。

帧：链路层的协议数据单元，封装网络层数据报。

数据链路层负责通过一条链路从一个结点向另一个物理链路直接相连的相邻结点传送数据报。

## 功能概述

数据链路层在物理层提供服务的基础上向网络层提供服务，其最基本的服务是将**源自网络层来的数据**可靠地传输到相邻结点的目标机网络层。
其主要作用是加强物理层传输原始比特流的功能，将物理层提供的可能出错的物理连接改造成为**逻辑上无差错**的**数据链路**，使之对网络层表现为一条无差错的链路。

+ 功能一：为网络层提供服务，无确认无连接服务，有确认无连接服务，有确认面向连接服务。

+ 功能二：链路管理，即连接的建立、维持、释放（用于面向的服务）。

+ 功能三：封装成帧。

+ 功能四：流量控制：限制发送方。

+ 功能五：差错控制（帧错/位错）

## 封装成帧

封装成帧就是在一段数据的前后部分添加首部和尾部，这样就构成了一个**帧**。接收端在收到物理层上交的比特流后，就能根据首部和尾部的标记，从收到的比特流中识别帧的开始和结束。

首部和尾部包含许多的控制信息，他们的一个重要作用：帧定界（确定帧的界限）

+ 帧同步：接收方应该能从接收到的二进制比特流中区分出帧的起始和终止

+ 四种方法：字符计数法，字符（字节）填充法，零比特填充法，违规编码法

![封装成帧](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/封装成帧.JPG)

## 透明传输

透明传输是指*不管所传数据是什么样的比特组合*都应该能够在链路上传送。因此链路层就“看不见”有什么妨碍数据传输的东西。

当所传数据中*比特组合恰好与某个控制信息完全一样*时，就必须采取适当的措施，使得接收方不会将这样的数据误认为是某种控制信息，这样才能保证数据链路层的传输是透明的。

透明传输的几种方法：

### 字符计数法

帧首部用一个计数字段（第一个字节，八位）来标明帧内字符数。

![字符计数法](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/字符计数法.JPG)

问题：万一这个计数字段也有问题

### 字符填充法

帧的三个部分：

![字符填充法](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/字符填充法.JPG)


+ SOH（start of header）00000001

+ 帧中的数据部分

+ EOT（end oftransmission）00000100

应用：传送文件是由文本文件组成时（文本文件字符都是从键盘上输入的，可用ascii码表达）。当传送的帧是由非ascii码的文本文件组成时（程序/图像等）就不行。可能在
信息中有和eot字段相同的组合，这时候就要采用字符填充的方法实现透明传输。

![字符填充法_发送接收](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/字符填充法_发送接收.JPG)


在与EOT相同的字段前加**转义字符**ESC作为字节填充，与转义字符ESC相同的前面也要添加

### 零比特填充法

操作：5-1-1-0 

+ 在发送端，扫描整个信息字段，只要连续5个1，就立即填入1个0

+ 在接收端收到一个帧时，先找到标志字段确定边界，再用硬件对 比特流 进行扫描。发现连续5个1时，就把后面的0删除。

保证了透明传输：在传送的比特流中可以传送任意比特组合，而不会引起对帧边界的判断错误。

### 违规编码法  

如曼彻斯特编码中：前高后低是1，前低后高是0。所以可以用高-高，低-低来定界帧的起始和终止。

由于字节计数法中count字段的脆弱性，及字符填充实现上的复杂性和不兼容性，目前较普遍使用的帧同步法是比特填充和违规编码法。

## 差错控制

### 差错从何而来

概括来说，传输中的差错都是由于噪声引起的。

1. 全局性：由于线路本身电气特性所产生的随机噪声，是信道固有，随机存在的。
解决办法：提高信噪比来避免干扰

2. 局部性：外界特定的短暂原因所造成的冲击噪声，是产生差错的主要原因。解决办法：编码技术


### 差错种类

+ 位错：比特位出错，1变0，0变1。

+ 帧错：丢失，重复，失序

### 如何差错控制

比特错：

+ 检错编码：奇偶校验码，循环冗余编码CRC

+ 纠错编码：海明码

编码vs编码：

数据链路层编码和物理层数据编码与调制不同。物理层编码针对的是单个比特，解决传输过程中比特的同步等问题，如曼彻斯特编码。
而数据链路层的编码针对的是一组比特。他通过冗余码的技术实现一组二进制比特串在传输过程中是否出现了差错。

冗余编码：在数据发送之前，先按某种关系附加上一定的冗余位, 构成一个符合一定规则的码字再发送。
接收端根据收到码字是否仍符合原规则，来判断是否出错

### 奇偶校验码

奇偶校验码：n-1位信息元，1位校验元。

+ 奇校验码：X..... 共n位：“1”的个数为奇数

+ 偶校验码反之

注意是加完校验码后，n长信息串中1的个数为奇数/偶数。and校验码在前面

奇偶校验码特点：只能检测出发生*奇数个*比特错误时的差错，即检错率50%。

### CRC循环冗余码


最终发送的数据是要发送的数据+**帧检验数列**FCS

![CRC循环冗余码](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/CRC循环冗余码.png)

![crc接收端检错](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/crc接收端检错.JPG)


总结：在数据链路层仅仅使用循环冗余检验CRC差错检测技术，只能做到对帧的无差错接收，即“凡是接收端数据链路层接受的帧，
都能以接近于1的概率认为这些帧在传输过程中没有产生差错”，接收端丢弃的帧虽然收到了，但是最终还是因为有差错被丢弃。

*凡是接收端数据链路层**接受**的帧均无差错*

不一定是“可靠传输”，可靠传输是指数据链路层发送端发送什么，接收端就收到什么。

链路层使用CRC检验，能够实现无比特差错的传输，但这还不是可靠传输。

### 纠错编码———海明码

海明码：发现双比特错，纠正单比特错。

**工作流程**：

确定校验码位数r -> 确定校验码和数据的位置 -> 求出校验码的值 -> 捡错纠错

![海明码求校验码](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/海明码求校验码.JPG)

1. 确定校验码位数r

	海明不等式

	2的r次方 > k+r+1，r为冗余信息位，k为信息位

	要发送的数据：D=101101

	数据的位数k=6，满足不等式的最小r为4，也就是D=101101的海明码应该有6+4=10位，其中原数据6位，校验码4位。

2. 确定校验码和数据的位置。


	放在2的几次方的位置

3. 求校验码的值

	令所有要校验的位异或 = 0。

4. 检测并纠错

	找出错误的位并纠错，令所有要校验的位异或运算。

## 流量控制与可靠传输机制

### 流量控制

较高的发送速度和较低的接受能力不匹配，会造成传输出错，因此流量控制也是数据链路层的一项重要工作。

数据链路层的流量控制是点对点的，**传输层**的流量控制是端到端的。

传输层流量控制手段：接收端给发送端一个窗口公告。

数据链路层流量控制手段：接收方收不下就不回复确认。

### 流量控制方法：

+ 停止-等待协议：每发送一个帧就停止发送，等待对方的确认，在收到确认后在发送下一个帧。

+ 滑动窗口协议：后退N帧协议（GBN），选择重传协议（SR）


停止-等待协议也可看作窗口大小均为1的滑动窗口

对比：

停止-等待协议：发送窗口大小 = 1，接收窗口大小 = 1
GBN：发送窗口大小 > 1，接收窗口大小 = 1
SR：发送窗口大小 > 1，接收窗口大小 > 1

(发送窗口，接受窗口大小在发送过程中是固定值)


### 回忆

可靠传输：发送端发啥 接收端收啥。

流量控制：控制发送速率，使得接收方有足够缓冲空间来接收每一个帧。

滑动窗口解决流量控制：收不下就不确认。

滑动窗口解决可靠传输：发送方自动重传。

## 停止-等待协议

### 为什么要有停止-等待协议？

除了比特出差错，底层信道还会出现丢包问题。

丢包：物理线路问题，设备问题，路由信息错误等导致数据包丢失。

### 研究停等协议的前提

虽然现在常用双工通信，为了讨论方便，仍划分为发送方，接收方。

停等，就是每发送完一个分组就停止发送，等待对方确认，在收到确认后发送下一个分组，

停等协议分为两种应用情况：有差错情况，无差错情况

### 无差错情况

![停等协议无差错](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/停等协议无差错.JPG)

### 有差错情况

ACK：确认帧（1bit的1和0编号就够）


1. 数据帧丢失或检测到帧出错

![数据帧丢失或检测到帧出错](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/数据帧丢失或检测到帧出错.png)

RTT：往返传播时延round trip time

2. ACK丢失

![停等协议有差错ack丢失](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/停等协议有差错ack丢失.JPG)

3. ACK迟到

![ACK迟到](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/ACK迟到.png)


### 性能分析

![停等协议性能分析](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/停等协议性能分析.png)


简单，信道利用率太低，但大部分时间都在路上

**信道利用率信道吞吐率**

发送方在一个周期内有效地发送数据所需要的时间占整个发送周期的比率

信道利用率 = （L/C）/T

T内发送L比特数据；发送周期T：从开始发送数据，到收到第一个确认帧为止；C：发送方数据传输率

**信道吞吐率** = 信道利用率*发送方的发送速率

![信道利用率信道吞吐率](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/信道利用率信道吞吐率.JPG)

### 流水线技术

增加缓存空间

![停等协议的弊端](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/停等协议的弊端.JPG)


## 滑动窗口：选择重传协议SR

Selective Repeat：可不可以只重传出错的帧？

SR：设置单个确认，同时加大接收窗口，设置接收缓存，缓存乱序到达的帧。

### 选择重传协议中的滑动窗口

![选择重传中的滑动窗口](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/选择重传中的滑动窗口.JPG)

（注意上下例子是分开的，不是同一个时序中）

### SR发送方必须相应的三件事

1. 上层的调用：

从上层收到数据后，SR发送方检查下一个可用于该帧的序号，如果序号位于发送窗口内，则发送数据帧，否则就像gbn一样，
要么将数据缓存，要么返回上层之后重新传输

2. 收到一个ack

如果收到ack，加入该帧序号在窗口内，则sr发送方将那个被确认的帧标记为已经接收，如果该帧序号是窗口的下界（最左边第一个窗口的序号），
则窗口向前移动到具有最好序号的*未确认帧*处。如果窗口移动了并且有序号在窗口内的未发送帧，则发送这些帧。

3. 超时时间

每个帧都有自己的定时器，一个超时事件后只重传该帧一个帧。

### 接收方要做的事

SR接收方将确认一个正确接收的帧而**不管其是否按序**。失序的帧将被缓存，并返回给发送方一个该帧的确认帧（收谁确认谁），
直到所有帧（即序号更小的帧）都被收到为止，这时才可以将一批帧按序交付给上层，然后向前移动滑动窗口。

### 运行中的SR

![运行中的SR](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/运行中的SR.JPG)


### 滑动窗口长度

1. 发送窗口最好等于接收窗口，大了会溢出，小了没意义

2. Wtmax = Wrmax = 2的（n-1）次方

### 总结：

1. 对数据帧逐一确认，收一个确认一个

2. 只重传出错帧

3. 接收方有缓存 

## 后退N帧协议GBN

### 滑动窗口

![后退n帧接收窗口](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/后退n帧接收窗口.JPG)

+ 发送端要拷贝副本，万一帧错误or丢失

+ 收到某个帧的确认后发确认，发送端滑动窗口后移

### GBN发送方必须相应的三件事：

1. 上层的调用

上层要发送数据时，发送方先检查发送窗口是否已满，如果未满，产生一个帧并发送，窗口已满时，发送方只需要将数据再返回给上层，
表明上层窗口已满，上层等一会儿在发送。实际中发送方可以缓存这些数据，窗口不满时再发送帧

2. 收到一个ack

gbn协议中，对n号帧采用累计确认方式，表明接收方已经收到n号帧和他之前的全部帧

3. 超时时间

后退n帧的名字，来源于出现丢失和时延过长时发送方的行为。就像停等协议中，定时器将再次用于恢复数据帧 或 确认帧的丢失。
如果出现超时，发送方重传所有已发送单位被确认的帧。

### 接收方要做的事：

如果正确收到n号帧，并且按序，那么接收方为n帧发送一个ack，并将该帧中数据的部分交付给上层（网络层）。

其余情况都丢弃帧，并为最近按序接收的帧重新发送ack。接收方无需缓存任何失序帧，
只需要维护一个信息：expectedseqnum（下一个按序接收的帧序号）

### 运行中的GBN

![运行中的GBN](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/运行中的GBN.JPG)


### 滑动窗口长度

若采用n个比特对帧编号，那么发送窗口的尺寸Wt应满足 1 <= Wt <= 2的n次方 -1。

若发送窗口尺寸过大，就会使得接收方无法区别新帧和旧帧

e.g. n = 2: 2的2次方 = 4

01230123，若发送窗口为大于3，可能有两个以上的0号帧

### 重点：

1. 累计确认：n号和n号之前都收到

2. 接收方只按顺序接受帧，不按序的话就全部丢弃

3. 确认序列号最大的，按序到达的帧。（解释不明白就不要说），
发送方可能收到0，2，3的确认，这说明0，2，3在接收方中都已经按序收到并确认了。
1可能发出了，但是没有被发送方收到，因为1如果没被接收方收到是不会发出2和3的确认帧的。


4. 发送窗口最大为，接受窗口只能是1。

### 性能分析：

pro：因为连续发送数据帧而提高了信道利用率

con：在重传时必须把原来已经正确传送的数据帧批量重传，使得传送效率降低（累计确认的优缺点）

## 信道划分 介质访问控制

+ **点对点链路：**
  两个相邻结点通过一个链路相连，没有第三者。应用：ppp协议，常用于广域网

+ **广播式链路：**
所有主机共享通信介质，应用：早起的总线以太网、无线局域网，常用于局域网。
典型拓扑结构：总线型，星型（逻辑总线型：中间的是集线器，通过集线器广播到连接的主机）

## 介质访问控制

采取一定的措施，使得两对节点之间的通信不会发生互相干扰的情况。

静态划分信道，动态分配信道

![介质访问控制](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/介质访问控制.JPG)

### 什么是信道划分介质访问控制

信道划分介质访问控制：MAC multiple access control

信道划分介质访问控制：将使用介质的每个设备与来自同一信道上的其他设备的通信隔离开，
把**时域**和**频域**资源合理地分配给网络上的设备。

![信道划分介质访问控制](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/信道划分介质访问控制.JPG)

多路复用技术：把多个信号组合在一条物理信道上进行传输，使得多个计算机或终端设备共享信道资源，提高信道利用率。

分用：把一条广播信道，逻辑上分成几条用于两个节点之间通信的互不干扰的子信道，实际就是把广播信道转化为点对点信道。


## 静态信道划分

频分多路复用FDM，时分多路复用TDM，波分多路复用WDM，码分多路复用CDM

+ 频分复用：不同用户在同样的时间占用不同的带宽。充分利用传输介质带宽，系统效率较高；由于技术比较成熟，实现也比较容易。

![频分多路复用fdm](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/频分多路复用fdm.JPG)


+ 时分复用：一个周期中各个用户占有一个*固定序号*的时隙,用户轮流占用信道。

![时分多路复用tdm](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/时分多路复用tdm.JPG)

+ 改进的时分复用————统计时分复用STDM：**集中器**按需动态分配时隙。

![统计时分复用stdm](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/统计时分复用stdm.JPG)

+ 波分多路复用：**光**的频分多路复用。

![波分多路复用wdm](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/波分多路复用wdm.JPG)

+ 码分多路复用：码分多址（CDMA）是码分复用的一种方式。m一般为64或128。这里的8是方便讲解（自己再查一下）

![码分多路复用cdm](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/码分多路复用cdm.JPG)


## 轮询访问介质访问控制

既不产生冲突，又要发送时占全部带宽。

轮询协议，令牌传递协议。

### 轮询协议

主节点轮流“邀请”从属结点发送数据。

问题：

+ 轮询开销

+ 等待延迟

+ 单点故障


### 令牌传递协议

令牌：一个特殊格式的mac控制帧，不含任何信息。控制信道的使用，确保同一时刻只有一个结点独占信道。令牌环网无碰撞

![令牌传递协议](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/令牌传递协议.JPG)

每个节点都可以在一定时间内（令牌持有时间）获得发送数据的权利，不是无限制地持有令牌

问题：令牌开销，等待延迟，单点故障

只应用于（逻辑拓扑的）令牌环网，采用令牌传送的方式通常用于负载较重，通信量较大的网络中。

## 动态分配信道 ALOHA协议

动态接入控制：信道并非在用户通信时固定地分配给用户。

### 纯aloha协议

思想：不监听信道，不按时间槽发送，*随机*重发。（想发就发）T0:发送时间，包括传输时间和传播时间。

![纯aloha协议](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/纯aloha协议.jpeg)

冲突如何检测：如果发生冲突，接收方就会检测出差错，然后不予确认，发送方在一定时间内收不到就判断发生了冲突。

冲突如何解决：超时后等一时间**随机重传**。重传重传直到收到确认帧。

### 时隙aloha协议

思想：把时间分成若干个相同的时间片，所有用户在时间片开始时刻同步接入网络信道，若发生冲突，则必须等到下一个时间片开始时刻再发送。（控制了想发就发的随意性）

![时隙aloha协议](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/时隙aloha协议.jpeg)

### 总结

纯aloha吞吐量较低，吞吐量：一段时间内成功发送的平均帧数。

纯aloha：想发就发，时隙aloha只能在时间片开始时才能发。

### 动态分配信道 CSMA协议

 CSMA：Carrier Sense Multiple Access 载波监听多路访问协议

CS：**载波监听/侦听**，每一个站在发送数据之前要检测一下总线上是否有其他计算机在发送数据

当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。当一个站检测到的信号电压摆动值超过一定门限值时，就认为总线上至少有两个站在同时发送数据，即发生冲突

MA：**多点接入**，即多个计算机以多点接入的方式连接在同一根总线上。

协议思想：发送帧之前监听信道。

监听结果：

信道空闲发送完整帧，有三个协议：1-坚持CSMA，非坚持CSMA，p-坚持CSMA

信道忙：推迟发送

#### * 1-坚持CSMA

坚持指的是对于监听信道忙之后的坚持。（再看一看）

+ 1-坚持csma思想：如果一个主机要发送消息，那么先监听信道。空闲则直接传输，不必等待。忙则保持监听，空闲时马上传输。冲突时（一段时间内未受到肯定回复），则等待一个随机长的时间后再监听，loop之前过程

+ 优点：只要媒体空闲，就马上发送，避免了媒体利用率的损失

+ 缺点：假如有两个或两个以上的站点有数据要发送，冲突就不可避免。

#### * 非坚持CSMA

非坚持指的是对于监听信道忙就不继续监听。

+ 思想：如果一个主机要发送消息，那么先监听信道，空闲则直接传输，不必等待。忙则等待一个随机时间之后再监听。

+ 优点：采用随机的重发延迟时间可以减少冲突发生的可能性。

+ 缺点：可能存在大家都在延迟等待过程中，使得媒体仍可能处于空闲状态，媒体使用率降低。

#### * p坚持CSMA

指的是对于监听信道空闲的处理。

+ 思想：如果一个主机要发送消息，那么先监听信道。*空闲*则以p概率直接传输，不必等待，1-p的概率等到下一个时间槽再传输。
*忙*则等待一个随机时间之后在进行监听。

+ 优点：既能像非坚持算法那样减少冲突，又能像1-坚持算法那样减少媒体空闲时间

+ 缺点：发生冲突后还是可能坚持把数据帧发送完，造成了浪费。

#### 对比

![CSMA对比](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/CSMA对比.jpeg)

### 动态分配信道 CSMA-CD协议 (先听再说，边听边说)

carrier sense multiple access with Collision Detection

CS：载波监听/侦听，每一个站在发送数据之前要检测一下总线上是否有其他计算机在发送数据

MA：多点接入，即多个计算机以多点接入的方式连接在同一根总线上。

CD：碰撞检测（冲突检测），“边发送边监听”，适配器边发送数据边检测信道上信号电压的变化情况，以便判断自己在发送数据时其他站是否也在发送数据。

思考：为什么先听后发还会冲突？因为电磁波在总线上总是以有限的速率传播的：传播时延，在双工通信中两个互相发送会冲突碰撞（尽管是双工半双工，指的是两条逻辑通路，一个物理通路）。

#### 传播时延对载波监听的影响

![传播时延对载波监听的影响](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/传播时延对载波监听的影响.JPG)

冲突，碰撞

![传播时延对载波监听的影响过程](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/传播时延对载波监听的影响过程.jpeg)

碰撞后信息发生叠加，可以检测出来。

最多是两倍的总线端到端的传播时延（2tao），总线的端到端往返传播时延，称为争用期/碰撞窗口/冲突窗口。

因此只要经过2tao时间还没有检测到碰撞，就能肯定这次发送不会发生碰撞。

#### 如何确定碰撞后的重传时机？

1. 确定基本退避（推迟）时间为争用期2tao。

2. 定义参数k，它等于重传参数，但k不超过10，即k=min（重传次数，10），当重传次数不超过10时，k等于重传次数，重传次数大于10时，k一直为10.

3. 从离散的整数集合[0,1,...,2的k次方 -1]中随即取出一个数r，重传所需要的退避时间就是r倍的*基本退避时间*，即2r*tao。

4. 当重传次数达到16次仍不能成功时，说明网络太拥挤，认为此帧永远无法正确发出，抛弃此帧并向高层报告出错。重传：截断二进制指数规避算法。

![截断二进制指数规避算法](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/截断二进制指数规避算法.JPG)

#### 总结

若连续多次冲突

#### 例题

![截断二进制指数规避习题](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/截断二进制指数规避习题.JPG)

#### 最小帧长

发了一个帧，但是发生了碰撞，但是在发送完之后才检测到发生碰撞，但是无法停止因为已经发完了。因此要最小帧长。

真的传输时延至少要两倍于信号在总线中的传播时延。（公式图片——）但最小64B，不足则填充

![帧传输最小帧长](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/帧传输最小帧长.JPG)

### 动态分配信道 CSMA-CA协议

CA：collision avoidance，不仅能检测，还能避免

场景：

CD：总线式以太网

CA：无线局域网：

+ 无法做到360度全面检测碰撞；

+ 隐蔽站：当终端A和C都检测不到信号，认为信道空闲时，同时向终端B发送数据帧，就会导致冲突

#### 工作原理

先听后说

空闲时则发出**RTS**（request to send），RTS包括发射端的地址，接收端的地址，下一份数据将持续发送的时间等信息；信道忙则等待。

接收端收到RTS之后，将响应**CTS**（clear to send）

发送端收到CTS后，开始发送数据帧，同时预约信道：发送方告知其他站点自己要传多久数据。

接收端收到数据帧后，将用crc检验数据，正确则发送ACK帧。

发送端收到ACK后就可以进行下一个数据帧的发送，若没有则一直重传至规定重发次数为止（二进制指数退避）

**过程总结：**

1. 预约信道

2. ACK帧

3. RTS/CTS帧

#### csma/cd 与 csma/ca总结

![csma/cd和csma/ca总结](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/csmacd和csmaca总结.JPG)


### 局域网

局域网LAN（Local Area Network），是指在某一区域内多台计算机互连成的计算机组，使用广播信道。

+ 覆盖地理范围较小，只能在一个相对独立区域内联

+ 使用专门铺设的传输介质（双绞线，同轴电缆等）进行联网，数据传输速率高

+ 通信延迟时间短，误码率低，可靠性较高

+ 各站为平等关系，共享传输信道

+ 多采用分布式控制和广播式通信，能广播和组播

局域网的主要要素：网络拓扑，传输介质和介质访问控制方法

#### 拓扑结构

星型，总线型，环形，树形

![局域网拓扑结构](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/局域网拓扑结构.JPG)


#### 局域网介质访问控制方法

+ **csma-md**， 常用语总线型，也用于树形网络

+ **令牌总线**，常用于总线型，也用于树形网络。它是把总线型或树形网络中的各个工作站按照一定顺序如按接口地址大小排列形成一个逻辑环，只有令牌持有者才能控制总线，才有发送信息的权利。

+ **令牌环**，用于环形局域网，如令牌环网

注意：逻辑拓扑和物理拓扑并不一定一样

#### 局域网分类

+ **以太网**：是应用最广泛的局域网，包括标准以太网，快速以太网(10Mbps)，千兆以太网(100Mbps)和10G以太网(1000Mbps)。逻辑拓扑是总线型，物理拓扑是星型或者拓展星型。使用CSMA-CD

+ 令牌环网：物理上是星型拓扑，逻辑上是*环形*拓扑结构，所以现在很少了

+ FDDI网（fiber distributed data interface）：物理上双环拓扑结构，逻辑上是环形拓扑，也很少

+ ATM网（asynchronous transfer mode)：较新型的单元交换技术，使用53字节固定长度的单元进行交换（说不明白就别说了

+ **无线局域网WLAN**（wireless local area network）：IEEE802标准（了解即可）

### MAC子层和LLC子层

IEEE802标准所描述的局域网参考模型对应OSI参考模型的数据链路层和物理层，它将数据链路层划分为逻辑链路层LLC，和介质访问控制MAC子层。（图片

![mac子层和llc子层](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/mac子层和llc子层.JPG)

+ LLC负责识别网络层协议，然后对他们进行封装。LLC报头告诉数据链路层一旦帧被接收时，应当对数据包如何处理。为网络层提供服务：无确认无连接、面向连接、带确认无连接、高速传送。

+ MAC子层的主要功能包括数据帧的封装/卸装，帧的寻址和识别，帧的接收和发送，链路的管理，帧的差错控制等。MAC子层的存在屏蔽了不同物理链路种类的差异性。

## 以太网Ethernet

是当今现有局域网采用的最通用的通信协议标准，使用CSMA-CD技术。

1. 造价低廉，以太网网卡不到100块

2. 是应用最广泛的局域网技术

3. 比令牌环网，ATM网便宜，简单

4. 满足网络速度要求：标准以太网，快速以太网，千兆以太网和10G以太网 10mb/s到10gb/s

### 以太网提供的是无连接，不可靠的服务

**无连接：** 发送方和接收方无握手过程

**不可靠：** 不对发送方的数据帧编号，接收方不想发送方进行确认，差错帧直接丢弃，差错纠正由更高层（传输层或称运输层）负责

因此只能无差错接收，不实现可靠传输。

### 拓扑结构的发展

总线型发展到星型

![以太网传输介质与拓扑结构](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/以太网传输介质与拓扑结构.JPG)

#### 10base-t以太网

![10base-t以太网](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/10base-t以太网.jpeg)

#### 适配器和mac地址

计算机与外界局域网的连接是通过通信适配器进行的。“网卡”，适配器也有处理器和存储器，存储器包括rom和ram。

ROM上有计算机硬件地址、物理地址、mac地址，是硬件的标识符。

MAC地址：每个适配器有一个全球唯一的48位二进制地址，前24位代表厂家，由IEEE规定，后24位厂家自己制定，常用6个十六进制数字表示。如02-60-8c-e4-b1-21，在生产适配器时，这6字节MAC地址已被固化在适配器的ROM中，是全球唯一的。

#### 以太网MAC帧

最常用的mac帧是以太网v2的格式。(!!!再自己看看)

![以太网mac帧](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/以太网mac帧.JPG)

注：数据长度范围：46-1500: 1500是mtu，最大数据传送单元，最小帧长64字节，之前有了18字节了，为了保证MAC帧是有效帧。

#### 高速以太网

![高速以太网](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/高速以太网.JPG)

### 无线局域网WLAN

WIFI属于WLAN

无线局域网通用标准：IEEE802.11

#### 802.11的mac帧头格式

![80211的mac帧头格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/80211的mac帧头格式.JPG)

#### 无线局域网分类

1. 有固定基础设施的无线局域网

![有固定基础设施的无线局域网](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/有固定基础设施的无线局域网.jpeg)

2. 无固定基础设施的无线局域网的自组织网络

![无固定基础设施的无线局域网的自组织网络](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/无固定基础设施的无线局域网的自组织网络.jpeg)

## PPP协议，HDLC协议

广域网（WAN wide area network）通常跨界很大的物理范围，所覆盖的范围从几十公里到几千公里，能连接多个城市或国家，或者横跨几个周并能提供远距离通信，形成国际性的远程网络。

广域网的通信子网使用**分组交换技术**，广域网的通信子网可以利用公用分组交换网，卫星通信网和无线分组交换网，将分布在各个地区的局域网或计算机系统互联起来，达到资源共享的目的。因特网是世界范围内最大的广域网。

![广域网](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/广域网.jpeg)

### PPP协议

点对点协议point-to-point protocol，是目前使用最广泛的数据链路层协议。用户使用拨号电话接入因特网时一般都用PPP协议。**只支持全双工链路**。

#### 应满足的要求：

+ **简单** 对于链路层的帧，无需纠错，无需序号，无需流量控制

+ **封装成帧** 帧定界符

+ **透明传输** 与帧定界符相同的比特组合数据时：异步线路用字节填充，同步线路用比特填充

+ **多种网络层协议** 封装的IP数据包可以采用多种协议

+ **多种类型链路** 串行/并行，同步/异步，电/光

+ **差错检测** 错就丢弃

+ **检测连接状态** 链路是否正常工作

+ **最大传送单元** 数据部分最大长度MTU

+ **网络层地址协商** 知道通信双方的网络层地址

#### 无需满足的要求

纠错，流量控制，序号，不支持多点线路

#### 三个组成部分

1. 一个将IP数据报封装到串行链路（同步串行/异步串行）的方法

2. 链路控制协议LCP：建立并维护数据链路连接（身份验证功能）

3. 网络控制协议NCP：PPP可支持多种网络层协议，每个不同的网络层协议都要一个相应的NCP来配置，为网络协议 建立和配置 逻辑链接。

#### 状态图 

![状态图](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/状态图.jpeg)

#### PPP协议的帧格式

![ppp协议的帧格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/PPP协议的帧格式.JPG)

![ppp协议的帧格式2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/PPP协议的帧格式2.JPG)

### HDLC协议

高级数据链路控制（high level data link control),是一个在同步网上传输数据，面向比特的数据链路层协议

数据报文可以实现**透明传输**，用于实现透明传输的“0比特插入法”易于硬件实现。

#### HDLC的站

主战，从站，复合站

![HDLC的站](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/HDLC的站.JPG)

#### HDLC的帧格式

![hdlc的帧格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/hdlc的帧格式.JPG)

### PPP协议和HDLC协议

HDLC，PPP都只支持全双工链路，都可以实现透明传输。都可以实现差错检测，但不纠正差错。

![ppp协议和hdlc协议](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/ppp协议和hdlc协议.JPG)

## 链路层设备

### 物理层扩展以太网

光纤（光纤调制器，光纤解调器）。集线器（集线器下的计算机们构成冲突域，只能同时有一个设备发送；主干集线器）

![物理层扩展以太网](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/物理层扩展以太网.JPG)

### 链路层扩展以太网

网桥或称交换机（!!!在看看一次）

![网桥交换机](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/网桥交换机.JPG)

把冲突域分隔开

**网段** 同一“物理层设备”

### 透明网桥

透明 是指以太网上的站点并不知道所发送的帧将经过哪几个网桥，是一种即插即用设备（自学习）

![透明网桥转发表](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/透明网桥转发表.jpeg)



### 源路由网桥

在发送帧的时候把详细的**最佳**路由信息（路由最少/时间最短）放在帧的首部中

方法： 源站以广播的方式向欲通信的目的站发送一个发现帧。（看看别的资料）

### 多接口网桥————以太网交换机

可以独占传输媒体带宽

![多接口网桥](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/多接口网桥.jpeg)

### 以太网交换机的两种交换方式

**直通式交换机** 查完目的地址（6B）就立刻转发。延迟小，可靠性低，无法支持具有不同速率的端口的交换。

**存储转发式交换机** 将帧放入高速缓存，并检查是否正确，正确则转发，错误则丢弃。延迟大，可靠性高，可以支持具有不同速率的端口的交换。

### 冲突域和广播域

![冲突域和广播域](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/冲突域和广播域.JPG)

链路域设备（交换机） 每个接口分割一个冲突域。

![冲突域和广播域练习](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter03/冲突域和广播域练习.jpeg)

4个冲突域和1个广播域





























# 第四章 网络层

## 概述

主要任务是把分组从远端传到目的段，为分组交换网上的不同主机提供通信服务。

网络层的传输单位是数据报。

+ 功能一：路由选择与分组转发：寻找最佳路径

+ 功能二：异构网络互联

+ 功能三：拥塞控制
：如果所有节点都来不及接受分组，而要丢弃大量分组的话，网络就处于拥塞状态，因此需要采取一定措施缓解这种拥塞。

    * 开环控制（静态）
    * 闭环控制（动态）

### 数据交换方式

如何使数据通过网络核心**路由器**从源主机到目的主机？————数据交换

### 为什么要数据交换？

### 数据交换方式

电路交换，报文交换，分组交换。分组交换又分数据报方式和虚电路方式

+ **电路交换**：例如电话网络

    * 建立连接（呼叫/电路建立） -> 通信 -> 释放连接（拆除电路）

    * 特点：独占资源

    * 优点：通信时延小，有序传输，没有冲突，实时性强

    * 缺点：建立连接时间长，线路独占，灵活性差，无差错控制能力

+ **报文交换**

    * 什么是报文：源应用发送的信息实体

    * 优点：不需要先建立连接；存储转发；动态分配线路；线路可靠性较高；线路利用率较高；多目标服务（指一个报文可以向多个目标传送）

    * 缺点：有存储转发时延；报文大小不定，需要网络节点有较大缓存空间。

+ **分组交换**

    * 把大的数据块分割成小的数据块。

    * 优点：无需建立连接；存储转发，动态分配线路；线路可靠性较高；线路利用率较高；相对于报文交换，存储管理更容易

    * 缺点：有存储转发时延；徐传输额外的信息量（每个报文都要有编号，头等）；乱序到达目的主机时，要对分组排序重组。

+ 报文交换和分组交换比较：

![报文交换分组交换比较](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/报文交换分组交换比较.JPG)


+ 三种数据交换方式比较总结

    ![三种数据报交换比较](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/三种数据报交换比较.JPG)


    1. 报文交换和分组交换都采用存储转发

    2. 传送数据量大，且传送时间远大于呼叫时，选择电路交换。电路交换传输时延最小。

    3. 从信道利用率来看，报文交换和分组交换优于电路交换，其中分组交换时延更小

+ 分组交换的**数据报方式**和**虚电路方式**

    * **数据报方式**为网络层提供无连接服务。无连接服务：不事先为分组的传输确定传输路径，每个分组独立确定传输路径，不同分组传输路径可能不同。

    * **虚电路方式**为网络层提供连接服务。有连接服务：首先为分组的传输确定传输路径（建立连接），然后沿该路径（连接）传输系列分组，系列分组传输路径相同，传输结束后拆除连接。

### 几种传输单元名词辨析

|  层 | 传输单元 |
|  ---- | ----  |
|  应用层  | 报文  |
|  传输层 | 报文段  |
| 网络层  | IP数据报，分组 |
| 数据链路层  | 帧 |
| 物理层  | 比特流 |

### 数据报（因特网使用）

无连接。

每一个分组携带源和目的地址

路由器根据分组的目的地址转发分组：基于路由协议/算法 构建转发表；检索转发表，每个分组独立选路

转发表，最基础的两列：目的网络地址，链路接口

### 虚电路

虚电路方式将数据报方式和电路交换方式结合，以发挥两者优点。
虚电路：一条源主机到目的主机类似于电路的路径（逻辑连接），
路径上所有的节点都要维持这条虚电路的建立，都维持一张虚电路表，
每一项记录了一个打开的虚电路的信息。

通信过程：

1. 建立连接（虚电路建立）：每个分组携带虚电路号，而非目的地址。源主机发送“呼叫请求“ 分组并收到“呼叫应答”分组后才算建立连接。

2. 数据传输：全双工通信

3. 释放连接（虚电路释放）：源主机发送“释放请求”分组 以拆除虚电路

### 数据报和虚电路比较

![数据报和虚电路](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/数据报和虚电路.JPG)

## IP数据报格式

### TCP/IP协议栈

TCP/IP协议栈的位置（橙色）

![TCP/IP协议栈](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/tcpip协议栈.JPG)

数据部分由运输层

![IPv4数据报格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/ipv4数据报格式.JPG)

固定部分为20字节固定长度

![IP数据报格式固定格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/IP数据报格式固定格式.JPG)

1. 版本：IPv4 or IPv6?

2. 首部长度：单位是4B，最小为5

3. 区分服务：指示期望获得那种类型的服务

4. 总长度：首部+数据长度，单位是1B

5. 生存时间（TTL）：IP分组的保质期，经过一个路由器-1，变成0则丢弃，防止未交付的数据报无线在链路上传输

6. 协议：数据部分的协议

![协议名字段值](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/协议名字段值.JPG)

7. 首部检验和：只检验首部，注意经过每个路由器都要更新一下，因为生存时间，片偏移会发生变化

8. 源地址和目的地址，32位，现在的IPv4的地址长度

9. 可选字段：0-40B，用来支持排错、测量以及安全等措施

10. 填充：全0，把首部补成4B的整数倍

## IP数据报分片

最大传送单元MTU：链路层**数据帧**可封装数据的上限。

以太网的MTU是1500字节

![最大传送单元MTU](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/最大传送单元MTU.JPG)

如果所传诵的数据报长度超过某链路的MTU值怎么办？————分片

11. 标识：统一数据报的不同分片使用同一标识

12. 标志：有三位但是只有两位有意义

    中间位DF（Dont Fragment)，DF=1禁止分片；DF=0允许分片

    最低位MF（More Fragment），MF=1，后面“还有分片”；MF=0，代表最后一片/）没有分片

13. 片偏移：指出较长分组分片后，某片在原分组中的相对位置，以8B为单位。

除了最后一个分片，每个分片长度一定是8B的整数倍。

### 例题

## IPv4地址

**IP地址：** 目的主机在哪个网络？哪个主机？
    全世界唯一的32位/4字节标识符，标识路由器主机的接口。IP地址::=网络号主机号（用另一个电脑修改一下，mac打不出来

### 分类的IP地址

（图片

以及特殊IP地址

（图片

因此有

以上这些都是”本网范围内“的私有IP地址

## 网络地址转换（NAT）

路由器对目的地址是私有IP地址的数据报一律不进行转发

网络地址转换NAT：在专用网连接到因特网的路由器上安装NAT软件，
安装了NAT软件的路由器叫NAT路由器，他至少有一个有效的外部全球IP地址。

（图片）

## 子网划分和子网掩码

分类的IP地址的弱点：

1. IP地址空间的利用率有时候很低

2. 两级IP地址不够灵活

图片（

两级IP地址->三级IP地址：某单位划分子网后，对外仍表现为一个网络，即本单位外的网络看不见本单位子网的划分。

子网掩码：

二级IP地址的子网掩码：只要是网络号都是1，主机号都是0；即255.255.0.0
（图片

三级，子网号部分也是全1。子网掩码与IP地址逐位相与，就得到子网网络地址。

子网掩码是用来确定有多少位是子网，多少位之后是主机号的。

## 使用子网时分组的转发

路由表中：

+ 目的网络地址

+ 目的网络子网掩码

+ 下一跳地址 

路由器转发分组的算法：

1. 提取目的IP地址

2. 是否直接交付

3. 特定主机路由

4. 检测路由表中有无路径

5. 默认路由0.0.0.0

6. 丢弃，报告转发分组错误

## 无分类编址CIDR

1. 消除了传统的A类，B类和C类地址以及划分子网的概念。
CIDR记法：IP地址后加上”/“，然后写上网络前缀，可以任意长度，的位置

（图片

2. 融合子网地址与子网掩码，方便子网划分。
CIDR把网络前缀相同的连续的IP地址组成一个”CIDR地址块“。
如：128.14.35.7/20是某CIDR地址块中的一个地址。
即：把128.14.35.7写成32位二进制，前二十位都是网络前缀。

（图片列成表格

### 构成超网

将多个子网聚合成一个较大的子网，叫做构成超网。或路由聚合。方法是将网络前缀缩短。



**最长前缀匹配**：使用CIDR时，查找路由表可能得到几个匹配结果，应选择**具有最长网络前缀**的路由。前缀越长，地址块越小，路由越具体。

（例题，写表格）
路由器R0的路由表见下表：若进入路由器R0的分组的目的地址是132.19.237.5,请问该分组应被转发到哪个下一跳路由器？ R2,(R3不匹配)

|  下一跳  |   目的网络  | 
|  ---- |  ---- | 
|   R1  |   132.0.0.0/8  | 
|   R2  |   132.0.0.0/11  | 
|   R3  |   132.19.232.0/22  | 
|   R4  |   0.0.0.0/8  | 

## ARP协议

由于在实际网络的链路上传送数据帧时，最终必须使用MAC地址。ARP协议：完成主机或路由器IP地址到MAC地址的映射。

ARP协议的使用过程：检查ARP高速缓存，有对应表项


## DHCP协议

## ICMP报文

ICMP协议支持主机或路由器：差错（或异常）报告，网络探询

### ICMP差错报告报文

1. 终点不可达：当路由器或主机不能交付数据报时就向原点发送终点不可达报文。

2. 源点一直：当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，
使源点知道应当把数据报的发送速率放慢

3. 时间超过：当路由器收到生存时间TTL=0的数据报时，除了丢弃该数据报外，还要向源点发送时间超过报文。当重点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。

4. 参数问题：当路由器或目的主机收到的数据报首部中有的字段的值不正确时，就丢弃该数据报。并向原点发送参数问题报文。

5. 改变路由（重定向）：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器。

（图片：ICMP差错报告报文数据字段

不应发送ICMP差错报文的情况

1. 对ICMP差错报告报文不再发送ICMP差错报告报文

2. 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报文

3. 对具有组播地址的数据报都不发送ICMP差错报告报文

4. 对具有特殊地址的数据报（本网络内的本主机地址0.0.0.0，环回地址127.0.0.0）都不发送ICMP差错报告报文

### ICMP询问报文

1. 回送请求和回答报文：主机或路由器向特定目的主机发送的询问（PING），收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。

2. 时间戳请求和回答报文：请某个主机或路由器回答当前的日期和时间，用来进行时钟同步和测量时间

3. 掩码地址请求和回答报文

4. 路由器询问和通告报文：3，4都不再使用

### ICMP的应用

PING：测试两个主机之间的连通性，使用了ICMP回送请求和回答报文

Traceroute：跟踪一个分组从源点到终点的路径，使用了ICMP时间超过差错报告报文。

把TTL依次设置为1，2，3...，就可以测算出终点到源点的距离


## IPv6

32位IPv4空间已经分配殆尽，采用CIDR和NAT，但是没有太大改善，
于是使用IPv6，从根本上解决了地址耗尽的问题。

IPv6改进了首部格式，加快路由器处理速度，转发数据报速度

支持QoS：Quality of Service，指一个网络能利用各种基础技术，
为指定的网络通信提供更好的服务能力，是一种安全机制，
用来解决网络延迟和阻塞的一种技术

### IPv6的数据报格式

固定40B首部：

![IPv6数据报格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/ipv6数据报格式.JPG)

+ 版本：指明了协议版本，总是6

+ 优先级：区分数据报的类别和优先级

+ 流标签：“流”是指互联网上从特定源点到特定终点的一系列数据报，所有属于同一个流的数据报都属于同一个流标签。

+ 有效载荷长度：指扩展首部/数据的长度

+ 下一个首部：表示下一个扩展首部或者上层协议首部

+ 跳数限制：相当于IPv4的TTL

+ 源地址和目的地址都变成了128位，IPv4是32位

### IPv6和IPv4的区别

1. IPv6将地址从32位（4B）扩展到了128位（16B），更大的地址空间。

2. IPv6移除了校验和字段，以减少每一跳的处理时间

3. IPv6将IPv4的可选字段移出了首部，放入扩展首部，成为更灵活的首部格式，路由器通常不对扩展首部进行检查，提高了路由器处理效率

4. IPv6支持即插即用，不需要**DHCP协议**

5. IPv6首部长度必须是8B整数倍，IPv4首部是4B的整数倍。

6. IPv6只能在主机处分辨，IPv4可以在路由器和主机处分片

7. ICMPv6:附加报文类型”分组过大“

8. IPv6支持资源的与分配，支持实时视像等要求，保证一定的带宽和时延的应用，

9. IPv6取消了协议字段，改为”下一个首部“字段

10. IPv6取消了总长度字段，改为有效载荷长度的字段

11. IPv6取消了服务类型字段

### IPv6的地址表示形式

+ 冒号十六进制记法：4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170

+ 压缩形式：把0000写成0
    
    零压缩：一连串连续的0可以被一对冒号取代，但双冒号法在一个地址中仅可出现一次，如：FF05:0:0:0:0:0:0:B3 -> FF05::B3

### IPv6基本地址类型

+ 单播：一对一通信，可做源地址+目的地址

+ 多播：一对多通信，可做目的地址

+ 任播：一对多当中的一个通信，可做目的地址

### IPv4向IPv6的过渡策略

+ 双栈协议：在一台设备上同时启用IPv4和IPv6协议栈

+ 隧道技术：隧道协议将其他协议的数据帧或包重新封装然后通过隧道发送

## 路由算法以及路由协议

![路由算法1](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/路由算法1.JPG)

路由表/转发表中的表项是由那里得到的呢？路由算法

最佳路由：“最佳”只是相对于某一种特定要求下得出的较为合理的选择。


路由算法：
+ 静态路由算法（非自适应的路由算法）：管理员手工配置路由信息。

    简便、可靠，在负荷稳定，拓扑变化不大的网络中运行效果很好，
广泛用于高度安全性的军事网络和娇小的商业网络。

    路由更新慢，不适用于大型网络。


+ 动态路由算法（自适应的路由算法）：路由器间彼此交换信息，按照路由算法 优化出 路由表项。

    路由更新快，适用于大型网络，及时响应链路费用或网络拓扑变化。

    算法复杂，增加网络负担。

动态路由算法：

+ 全局性：链路状态路由算法OSPF：所有路由器掌握完整的网络拓扑和链路费用信息。

+ 分散性：距离向量路由算法RIP：路由器只掌握物理相连的邻居及链路费用。

分层次的路由选择协议

+ 因特网规模很大

1. 因特网规模很大

2. 许多单位不想让外界知道自己的路由选择协议，但还想连入因特网

    自治系统AS：（图片补文字


![AS1](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/AS1.JPG)


![AS2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/AS2.JPG)

![AS3](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/AS3.JPG)


## RIP协议和距离向量算法

回顾：

![AS2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/AS2.jpeg)

RIP协议是一种分布式的，基于距离向量的路由选择协议，是因特网的协议标准，最大优点是简单。

RIP协议要求网络中**每一个路由器**都维护从它自己到其他**每一个目的网络**的唯一最佳距离纪录（跳数）

例子：R2的路由表


![R2的路由表](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/R2的路由表.jpeg)

距离通常指“跳数”，即从源端口到目的端口所经过的路由器个数，经过一个路由器跳数+1，特别的，从一路由器到直接连接的网络距离为1。RIP允许一条路由最多只能包含15个路由器，因此距离为**16表示网络不可达**。

因此RIP只适用于小互联网。

路由表是如何建立的？即和其他路由器交换信息。问题

+ RIP协议和谁交换：仅和相邻路由器交换信息
    
+ 交换什么：路由器交换的是自己的路由表

+ 多久交换一次：每30s交换一次路由信息，然后路由器根据新信息更新路由表，
若超过180没有收到邻居路由器的通告，则判定邻居没了并更新自己的路由表

    路由器刚开始工作时，只知道直接连接的网络距离（为1），
接着每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。

    若干次更新后所有路由器将会知道到达本自治系统任何一个网络的最短距离和下一跳路由器的地址

由距离向量算法更新

1. 修改相邻路由器发来的RIP报文中所有表项

    对地址为X的相邻路由器发来的报文，修改此报文中所有项目：
    把“下一跳”字段中的地址改为X，并把所有的“距离”字段+1.

2. 


3. 

4. 返回

图片，补文字

![距离向量算法](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/距离向量算法.jpeg)


RIP协议报文格式

![RIP协议报文格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/RIP协议报文格式.jpeg)

RIP是应用层协议，使用UDP传送数据

一个RIP报文最多可以包括25个路由，如果超过，必须在用一个RIP报文发送

RIP协议：好消息传得快，坏消息传的慢，
即网络出现故障时需要经过比较长的时间才能将此信息传送到所有的路由器。“慢收敛”。

## OSPF协议及链路状态算法

**开放最短路径优先OSPF协议：** 开放是指公开发表的，不受某厂商控制。
最短路径优先指使用Dijistra提出的最短路径算法SPF。

OSPF最主要特征是使用分布式的链路状态协议

问题：

+ 和谁交换：使用洪范算法像自治系统内所有路由器发送信息，即路由器通过输出端口向所有相邻的路由器发送信息，而每一个相邻路由器又再次将此信息发往其所有的相邻路由器。”广播“

+ 交换什么：发送的信息就是与本路由器相邻的所有路由器的链路状态。（本路由器和哪些路由器相邻，以及该链路的度量/代价，如费用、距离、时延、带宽等）

+ 多久交换：只有当链路状态发生变化时，路由器才向所有路由器洪范发送此信息。

    最后，所有路由器都能建立一个链路状态数据库，即全网拓扑图

链路状态路由算法

（补一下文字

![链路状态路由算法](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/链路状态路由算法.jpeg)

7. 使用Dijkstra根据自己的链路状态数据库构造到其他节点间的最短路径。

### OSPF的区域

![OSPF的区域](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/OSPF的区域.JPG)

### OSPF分组

OSPF分组用IP数据报传送，RIP是用UDP

![OSPF分组](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/OSPF分组.JPG)

### 其他特点

1. 每隔30min，要刷新一次数据库中的链路状态

2. 由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此当互联网规模很大时，OSPF协议要比距离向量协议RIP好很多。

3. OSPF不存在坏消息传递慢的问题，收敛速度快


## BGP协议

问题：

![BGP结构](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/BGP结构.jpeg)


+ 和谁交换？与其他的AS的邻站BGP发言人交换信息。

+ 交换什么？交换的网络可达性的信息，即要到达某个网络所要经过的一系列AS

+ 多久交换？发生变化时更新有变化的部分。

BGP交换的网络**可达性的信息**就是要到达某一个网络所要经过的一系列AS。
当BGP发言人互相交换了网络可达性的信息之后，
各个BGP发言人就根据所采用的策略从收到的路由信息中找出到达各个AS的较好路由

AS：自治系统

### BGP协议交换信息的过程

BGP发言人交换路径向量：

![BGP协议交换信息的过程1](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/BGP协议交换信息的过程1.JPG)

![BGP协议交换信息的过程2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/BGP协议交换信息的过程2.JPG)


### BGP协议报文格式

BGP是一个应用层协议

![BGP协议报文格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/BGP协议报文格式.JPG)

### BGP协议特点

支持CIDR，因此BGP的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所哟经过的各个自治系统的序列。在BGP刚刚运行时，BGP的邻站是交换整个BGP路由表，但是以后只需要在发生变化时更新有变化的部分，节省网络带宽和减少路由器的处理开销。

### BGP的四种报文

1. OPEN报文：用来与相邻的另一个BGP发言人建立关系，并认证发送方。

2. UPDATE报文：通告新路径或撤销原路径

3. KEEPALIVE报文：在无UPDATE时，周期性证实邻站的联通性，也作为OPEN的确认。

4. NOTIFICATION报文：报告先前报文的差错，也被用于关闭连接。

### 三种路由协议比较

1. RIP：一种分布式的基于距离向量的内部网关路由选择协议，通过广播UDP报文来交换路由信息。

2. OSPF：是一个内部网关协议，要交换的信息量较大，应使报文的长度尽量短，所以不是用传输层协议，而是直接采用IP

3. BGP是一个外部网关协议，在不同的自治系统之间交换路由信息，由于网络环境复杂，需要保证可靠传输，所以采用TCP

![三种路由协议比较](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/三种路由协议比较.JPG)

## IP组播

IP数据报的三种传输方式：单播，广播，组播（多播）

* 单播：单播用于发送数据包到单个目的地，且每发送一份单播报文都使用一个单播IP地址作为目的地址，是一种点对点传送方式。

* 广播：广播是指发送数据包到同一广播域或子网内的所有设备的一种数据传输方式，是一种点对多点的传输方式

* 组播（多播）：点对多点的传播方式

![组播多播](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/组播多播.jpeg)


单播，组播示意图


### IP组播地址

IP组播地址让源设备能够将分组发送给一组设备，
属于多播组的设备将被分配一个组播组IP地址（一群共同需求主机的相同标识）。

组播地址范围是224.0.0.0 - 239.255.255.255（D类地址）

1. 组播数据报也是“尽最大努力交付”，不提供可靠交付，应用于UDP

2. 对组播数据报不产生ICMP差错报文

3. 并非所有D类地址都可以作为组播地址。有些地址已经被指派为永久组播地址

## 移动IP

### 移动IP概念

![移动IP概念](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/移动IP概念.jpeg)


### 移动IP通信过程

![移动IP通信过程](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/移动IP通信过程.jpeg)

3. 外部代理拆封数据报并发给A

A移动到了下一个网络

![移动IP通信过程2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/移动IP通信过程2.jpeg)

## 网络层设备

路由器：是一种具有多个输入端口和多个输出端口的专用计算机，其任务是转发分组

**路由器结构：**

![路由器结构](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/路由器结构.jpeg)

**路由选择：** 根据所选定的路由选择协议构造出路由表，同时经常或定期的与相邻路由器交换路由信息而不断的更新和维护路由表。

**分组转发：** 交换结构：根据转发表（路由表得来）对分组进行转发。转发vs路由选择：

输入端口对线路上收到分组的处理

![输入端口对线路上收到分组的处理](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/输入端口对线路上收到分组的处理.jpeg)

输出端口对线路上收到分组的处理

![输出端口对线路上收到分组的处理](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/输出端口对线路上收到分组的处理.jpeg)

若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃

路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因。


### 三层设备的区别


![三层设备的区别](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/三层设备的区别.jpeg)

### 路由表和路由转发

路由表是根据路由选择算法得出的，主要作用是路由选择，总用软件来实现

默认路由

路由转发是

![路由表和路由转发](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/路由表和路由转发.jpeg)



# 第五章 传输层

## 概述

只有主机才有的层次

为应用层提供服务，使用网络层的服务。

功能

+ 传输层提供进程和进程之间的逻辑通信（网络层提供主机之间的逻辑通信）

+ 复用和分用：

+ 传输层对收到的报文进行差错检测。检测头部，因为内容在网络层中检测过了

两个协议：TCP（靠谱），UDP（不靠谱）
（文字补一下）（图片——

![传输层两个协议简介](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/传输层两个协议简介.png)

+ TCP：面向连接的传输控制协议：要先建立连接。可靠，面向连接，时延大，适用于大文件

+ UDP：无连接的用户数据报协议：不可靠，无连接，时延小，适用于小文件

### 传输层的寻址与端口

+ 复用：应用层所有的应用进程都可以通过传输层再传输到网络层

+ 分用：传输层从网络层收到数据后交付指明的应用进程

端口：指的是逻辑端口/软件端口，是传输层的SAP，标识主机中的应用进程。

端口号只有本地意义，在因特网中不同计算机的相同端口没有联系。

端口长度有16bit，能表示65536个不同的端口号

![传输层的寻址与端口1](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/传输层的寻址与端口1.png)

![传输层的寻址与端口2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/传输层的寻址与端口2.png)

在网络中采用发送方和接收方的套接字组合来识别端点，套接字唯一标识了网络中的一个主机和它上面的一个进程。

套接字（Socket）=（主机ip地址，端口号）

## UDP

### 概述

只在ip数据报服务上增加了很少功能，即复用分用和差错检测。

UDP的主要特点：

+ UDP是无连接的，减少开销和发送数据之前的时延

+ UDP使用最大努力交付，既不保证可靠交付。

+ UDP是面向报文的，适合一次性传输少量数据的网络应用

    应用层产生应用层报文 -> 传输层

    ![UDP概述](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/UDP概述.png)

    应用层给udp多长的报文，udp就照样发送，一次发一个完整报文

    如果太大量数据，网络层还要分片。

+ UDP没有拥塞控制，适合很多实时应用，比如ip电话等，不用拥塞控制，丢掉一点信息也ok，但不能有延迟

+ UDP首部开销小，8字节。TCP首部：20字节

### UDP首部格式

16位原端口号可有可无，目的端口号一定要有

UDP长度：整个（首部+数据）数据报的长度

UDP检验和：检测整个udp数据报是否有错，错就丢弃

分用时，找不到对应目的端口号，就丢弃报文，并给发送方发送ICMP“端口不可达”的差错报文

![UDP报文首部格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/UDP报文首部格式.png)

### UDP校验

17: 封装udp报文的ip数据报首部协议字段是17。

伪首部只有在计算检验和时才出现，不想下传送也不向上递交。

udp长度：udp首部8B+数据部分长度（不包括伪首部）

![UDP校验伪首部](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/UDP校验伪首部.png)

### （用伪首部）进行UDP校验

![UDP校验2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/UDP校验2.png)


## TCP协议

### TCP协议特点和TCP报文段

1. 面向连接（虚连接）的传输层协议，虚连接：先建立连接

2. 每一条TCP连接只能有两个端点，每一条TCP连接只能是点对点

3. TCP提供可靠交付的服务，无差错，不丢失，不重复，按序到达

4. TCP提供全双工通信：所以都设置发送缓存和接收缓存

    发送缓存：准备发送的数据，已经发送但没收到ACK的数据，
    
    接收缓存：按序到达但尚未被接受应用程序读取的数据，不按序到达的数据。

5. 面向**字节流**：TCP把应用程序交下来的数据看成仅仅是一连串的无结构的字节流

    流：流入到进程或从进程流出的字节队列

### TCP报文段首部格式

![TCP报文首部格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/TCP报文首部格式.png)

序号：在一个TCP连接中传送的**字节流**中的每一个字节都按顺序编号,
本字段表示本报文段所发送数据的第一个字节的序号。

**确认号** 期望收到**对方下一个**报文段的第一个数据字节的序号。若确认号为N，
则证明到序号N-1为止的所有数据都已经正确收到

数据偏移（首部的长度）：TCP报文段的数据起始处距离TCP报文段的起始处有多远，以4B为单位，即1个数值是4B。这样就知道TCP数据部分从哪里开始。因为选项和填充字段长度不定



控制位：

+ **紧急位URG：** URG=1时，此报文段中有紧急数据，是高优先级的数据，应尽快传送，不用在缓存里排队。配合紧急指针字段使用。（发送方

+ **确认段ACK：** ACK=1时，确认号有效，在连接建立后所有传送的报文段都必须把ACK置为1。

+ 推送位PSH：PSH=1时，接收方尽快交付接受应用层，不再等到缓存填满再向上交付。（与URG区分：接收方

+ 复位层RST：RST=1时，表明TCP连接中出现严重差错，需要释放连接，重新建立传输连接

+ **同步位SYN：** SYN=1时，表明是一个连接请求/连接接受报文

+ **终止位FIN：** FIN=1时，表明此报文段发送方数据已发完，要求释放连接

窗口：16位两字节，指的是发送本报文段的一方的接收窗口，即现在允许对方发送的数据量。

紧急指针：URG=1时有意义，指出本报文段中紧急数据的字节数

检验和：检验首部+数据，检验时要加上12B伪首部，第四个字段为6

选项：最大报文长度MSS，窗口扩大，时间戳，选择确认。。。（internet发展后的一些新特点）

填充字段：为了使TCP报文首部是4字节的整数倍，选项可能不是4字节的整数倍

### TCP连接

TCP连接传输的三个阶段：连接建立，数据传输，连接释放。

#### 建立连接 

TCP连接的建立采用客户服务器方式，主动发动 连接建立的应用进程叫客户，等待连接建立的应用进程叫服务器。

假设运行在一台主机（客户）上的一个进程想与另一台主机（服务器）上的一个进程建立一条连接，
客户应用进程首先通知客户tcp，他想建立一个与服务器上某个进程之间的连接，客户中的TCP会用以下步骤与服务器中的TCP建立一条TCP连接。

三次握手：

![三次握手](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/三次握手.png)

ROUND1: 客户端发送连接请求报文段，**无应用层数据**
    SYN=1，seq=x

ROUND2: 服务器为该TCP连接分配缓存和变量，并向客户端返回确认报文段，允许连接，无应用层数据。
    SYN=1, ACK=1,seq=y,ack=x+1（小写ack是确认号）

ROUND3: 客户端为该TCP连接**分配缓存和变量**，并向服务器端返回确认的确认，可以携带数据
    SYN=1, ACK=1, seq=x+1, ack=y+1

SYN洪范攻击：

![SYN洪范攻击](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/SYN洪范攻击.png)

解决办法：设置SYN Cookie（了解）

#### 释放连接

参与一条TCP的两个进程中的任何一个都能终止该链接，连接结束后，主机中的“资源”（缓存和变量）将被释放。

![四次握手](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/四次握手.png)

ROUND1: 客户端发送连接释放报文段，停止发送数据，主动关闭TCP连接。
FIN=1，seq=u

ROUND2: 服务器端回送一个确认报文段，客户到服务器这个方向的连接就释放了（半关闭状态）

ACK=1, seq=v, ack=u+1

ROUND3: 服务器端发完数据，就发出连接释放报文段，主动关闭TCP连接。

FIN=1，ACK=1，seq=w，ack=u+1s

ROUND4: 客户端会送一个确认报文段，再等到 时间等待计时器 设置的2MSL（最长报文段寿命）后，连接彻底关闭。

2MSL：万一服务器半关闭之后发送的报文有问题，还可以重置时间等待计时器、重传报文段，
（再看一下别的，如何确定2msl

### TCP可靠传输

TCP实现可靠传输的机制：校验，序号，确认，重传

+ 校验：和UDP校验一样，添加伪首部

+ 序号：“字节流” 一个字节占一个序号，序号字段指的是一个报文段第一个字节的序号。

+ 确认：报文段首部“确认号”

+ 重传：超时重传，TCP的发送方在规定时间内没有收到确认就要重传已发送的报文段。

    * TCP采用自适应算法，动态改变重传时间RTTs（加权平均往返时间）。

    * 冗余ACK：每当比期望序号大的失序报文段到达时，发送一个冗余ACK，指明下一个期待字节的序号。
    例子：发送方发送1，2，3，4，5报文段。接收方收到1，返回给1的确认，（没收到2），收到3，返回1的确认，收到4，5仍返回1的确认。发送方收到三个对于报文段1的冗余ACK，认为2报文段丢失，重传2号报文段。称为**快速重传**

### TCP流量控制

![TCP流量控制](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/TCP流量控制.png)

让发送方发慢点，让接收方来得及接收。

TCP利用滑动窗口机制实现流量控制。

在通信过程中，接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小，
即接收窗口rwnd（接收方设置确认报文段的窗口字段来将rwnd通知给发送方），
发送方的发送窗口 取 接受窗口rwnd 和 拥塞窗口cwnd 的最小值。

rwnd：接收方根据接收缓存设置的值，并告知给发送方，反映接收方容量。

cwnd：发送方根据自己估算的网络拥塞程度而设置的窗口值，反映网络当前容量。

TCP为每一个连接设有一个持续计时器，只要tcp连接的一方收到对方的零窗口通知，就启动持续计时器。

若持续计时器设置的时间到期，就发送一个零窗口探测报文段。接收方收到探测报文段时给出现在的窗口值。

若窗口仍为0，那么发送方就重新设置持续计时器。

### TCP拥塞控制

出现拥塞：对资源需求的总和 > 可用资源（网络中的链路容量，带宽；交换节点中的缓存，处理机等）

网络中有许多资源同时呈现供应不足 -> 网络性能变坏 -> 网络吞吐量将随输入负荷增大而下降

拥塞控制：防止过多数据注入到网络

拥塞控制&流量控制：拥塞控制是全局问题，拥塞控制是一个点到点问题，如果流量大就让发送方不要发

四种算法：

+ 假定：
    
    * 模型只看做数据单方向传送，另一方只传送确认
    
    * 接收方总是有足够大的缓存空间，因而发送窗口大小取决于拥塞程度。

+ 慢开始和拥塞避免算法

![慢开始](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/慢开始.png)


拥塞窗口以一个报文段长度MSS为单位。

一个传输轮次：发送了一批报文段并收到他们的确认的时间。
也指一个往返时延RTT。
也可以定义为开始发送一批拥塞窗口内的报文段 到开始发送下一批拥塞窗口内的报文段的时间。

ssthresh：slow start threshold 慢开始阈值。加法增大以拥塞避免。进入“慢开始”

到达网络拥塞之后，瞬间减少到“1个报文段”

设置新的ssthresh：发生网络拥塞时，把当时的拥塞窗口除以二作为新的ssthresh。或者加三除以二？？？（看看其他资料


+ 快重传和快恢复：

![快重传和快恢复](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter05/快重传和快恢复.png)

快恢复不用从慢开始的1个报文段大小开始，而是直接从新的ssthresh。
# 第六章 应用层

## 应用层概述 

最上层，最顶层：对应用程序的通信提供服务。

应用层对**应用程序**的通信提供服务。

应用层协议定义

+ 应用进程交换的报文类型，请求还是响应

+ 各种报文类型的语法，如报文中的各个字段及其详细描述。

+ 字段的语义，即包含在字段中的信息的含义。

+ 进程何时and如何发送报文，以及对报文进行响应的规则。

应用层的**功能**

+ 文件传输，访问和管理

+ 电子邮件

+ 虚拟终端

+ 查询服务和远程作业登陆

应用层的重要协议：

+ FTP

+ SMTP/POP3

+ HTTP

+ DNS

## 网络应用模型

客户/服务器模型（client/server），p2p模型（peer to peer）

## C/S 模型

**服务器** 提供计算服务的设备。

1. 永久提供服务

2. 永久性的域名

**客户机** 请求计算服务的主机

1. 与服务器通信，使用服务器提供的服务

2. 间歇性接入网络

3. 可能使用动态ip地址

4. 不与其他客户机**直接**通信，先与服务器，再和客户机

应用： Web，文件传输FTP，远程登录，电子邮件

![CS模型](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/CS模型.png)

## p2p模型peer to peer

也叫对等模型，不存在永远在线的服务器。每个主机既可以提供服务，也可以请求服务

1. 任意端系统/节点之间可以直接通讯

2. 节点间歇性接入网络

3. 节点可能改变ip地址

4. 可扩展性好

5. 网络健壮性robustness好

![P2P模型](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/P2P模型.png)

## 域名解析系统DNS

Domain Name System域名解析系统，通过ip地址找到网站。用域名替代ip地址，如 www.baidu.com

![DNS工作过程](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/DNS工作过程.png)



### 域名

从左到右由低到高：www（三级域名）.baidu(二级域名).com（顶级域名）

顶级域名：国家顶级域名，通用顶级域名，基础结构域名/反向域名

二级域名：类别域名：ac、com、edu、gov；行政区域名：省市直辖市等

三级域名：mail;www;ftp;mail

四级域名：

### 域名服务器（dns服务器）

IP地址和域名的解析

+ 根域名服务器：最高层，有十三个不同的跟域名服务器，a.rootservers.net to m.rootservers.net

+ 顶级域名服务器:管理该顶级域名服务器注册的所有二级域名。

+ 权限域名服务器：负责一个区的域名服务器。

+ 本地域名服务器：当一个主机发出dns查询请求时，这个查询请求报文就发给**本地**域名服务器。


### 域名解析过程

递归查询，迭代查询：递归是用户只向本地DNS服务器发出请求，然后等待肯定或否定答案。而迭代是本地服务器向根DNS服务器发出请求，而根DNS服务器只是给出下一级DNS服务器的地址，然后本地DNS服务器再向下一级DNS发送查询请求直至得到最终答案。

[递归查询，迭代查询](https://blog.csdn.net/yanbao4070/article/details/79892032#:~:text=question%2F311381817.html-,DNS%E8%BF%AD%E4%BB%A3%E5%92%8C%E9%80%92%E5%BD%92%E7%9A%84%E5%8C%BA%E5%88%AB,%E8%AF%B7%E6%B1%82%E7%9B%B4%E8%87%B3%E5%BE%97%E5%88%B0%E6%9C%80%E7%BB%88%E7%AD%94%E6%A1%88%E3%80%82)

![域名解析过程](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/域名解析过程.png)

用高速缓存存储最近查询的域名，提高域名解析速度

## 文件传输协议FTP

文件传输协议 File Transfer Protocol

简单文件传输协议 Trivial File Transfer Protocol

### 介绍

提供**不同种类主机系统（硬软件体系都可以不同）之间**文件传输的能力。 

拷贝：上传和下载

### FTP服务器和用户端

FTP是基于客户/服务器（C/S）的协议

+ 用户通过一个客户及程序连接至在远程计算机上运行的服务器程序

+ 依照ftp协议提供服务，进行文件传送的计算机就是FTP服务器

+ 连接FTP服务器，遵循FTP协议与服务器传送文件的电脑就是FTP客户端。

### 工作原理

+ 登陆 ftp地址：用户名&密码 匿名

![FTP工作原理](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/FTP工作原理.png)

+ FTP使用TCP实现可靠传输。

服务器进程：1个主进程，n个从属进程

![FTP工作原理2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/FTP工作原理2.png)

* 控制连接始终保持，只要建立连接。

* 数据连接保持一会儿

* 数据连接端口是否使用tcp20端口建立数据连接与传输模式有关

* 主动方式使用tcp20端口

* 被动方式由服务器和客户端自行协商决定（端口>1024）
（看看别的资料）

### FTP传输方式

+ 文本模式：ASCII模式，以文本序列传输数据

+ 二进制模式：Binary模式，以二进制序列传输数据

## 电子邮件

### 电子邮件的信息格式

信封 abc@163.com

内容 
+ 首部To，Subject
+ 主体

![电子邮件的信息格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/电子邮件信息格式.png)

### 组成结构

用户代理-邮件服务器-协议-邮件服务器-用户代理

![电子邮件系统组成结构](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/电子邮件系统组成结构.png)

![电子邮件系统组成结构2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/电子邮件系统组成结构2.png)

+ **用户代理**功能：撰写，显示，处理，通信

+ **邮件服务器**功能：发送&接收邮件，向发件人报告邮件传送结果（c/s结构）

+ **协议** 发送SMTP，接收POP3，IMAP

### 简单邮件传送协议SMTP

SMTP规定了两个相互通信的SMTP进程之间应如何交换信息。

负责发送邮件的SMTP进程就是SMTP客户，负责接收的进程就是SMTP服务器

14条命令（几个字母），21种应答信息（三维数字代码+简单文字说明）

![SMTP](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/SMTP.png)

SMTP三个阶段：连接建立，邮件传送，连接释放

+ 连接建立
+ 邮件发送
   DATA命令

+ 连接释放

SMTP的缺点：
+ SMTP不能传送可执行文件或者其他二进制对象

+ 仅限于传送7位ASCII码，不能传输其他非英语国家的文字

+ SMTP服务器会拒绝超过一定长度的邮件

### 通用因特网扩送MIME

![MIME](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/MIME.png)

### 邮局协议POP3

图片（pop3是绿箭头那个

pop3的工作方式：

+ 下载并保留在服务器

+ 下载并删除

### 忘记报文存取协议IMAP

比POP3 复杂

![IMAP](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/IMAP.png)

### 基于万维网的电子邮件

方便，注意中间协议不同

![基于万维网的电子邮件](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/基于万维网的电子邮件.png)

## 万维网

概述：万维网（world wide web）是一个大规模的，联机式的信息储藏所/资料空间，是无数个网络站点和网页的集合。

统一资源定位符URL 是 资源（文字，视频，音频）的唯一标识

URL的一般形式：<协议>://<主机>:<端口>/<路径>，URL不区分大小写

协议：http，ftp

主机：域名，ip地址

用户点击超链接获取资源，这些资源通过超文本传输协议HTTP传送给使用者。

万维网也是以c/s方式工作，用户使用的浏览器就是万维网客户程序，万维网文档所驻留的主机 运行 服务器程序

万维网通过使用超文本标记语言**HTML**，使得万维网页面设计者可以很方便地从一个界面的链接转到另一个界面，
并能够在自己的屏幕上显示出来

### HTTP

HTTP协议定义了浏览器（万维网客户进程）怎样向万维网服务器请求万维网文档，以及服务器怎样把文档传送给浏览器。

#### HTTP工作流程

![HTTP工作流程](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/HTTP工作流程.png)

#### HTTP协议特点

无状态：每次访问是相同响应，无记忆的。

但是在实际工作中，一些万维网站点常常希望能够识别用户。

Cookie：是存储在用户主机中的文本文件，记录一段时间内某用户（识别码来识别）的访问记录。提供个性化服务

HTTP采用TCP作为运输层协议，但是HTTP本身是无连接的，通信双方在交换HTTP报文之前不需要先建立HTTP链接。

![HTTP协议特点](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/HTTP协议特点.png)

#### 连接方式

![HTTP连接方式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/HTTP连接方式.png)

非持久连接耗时：两个rtt。

持久连接：保持连接，再想发信息就不用再建立连接

右图是非流水线式的，请求一个发一个，接受一个确认一个

流水线式可以同时多发

#### HTTP的报文结构

![HTTP报文结构](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/HTTP报文结构.png)

#### 状态码

3xx表示重定向，请求的网页转移到了新定位

![HTTP状态码](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/HTTP状态码.png)

### HTTPS

hyper text transfer protocol over securesocket layer

#### **HTTP问题：** 

HTTP数据传输过程中所有的数据都是明文传输，容易被窃听截取。
数据的完整性未校验，容易被篡改
没有验证对方身份，存在冒充危险

在http的基础上通过传输加密和身份认证保证了传输过程的安全性，原理：在http的基础上加入ssl（安全套接层）层或者TLS（安全传输层协议），混合加密。混合加密是指对称加密（解密加密都是同一个密钥，密钥管理负担问题，密钥也被截获的问题）和非对称加密（公钥私钥）。


![https和http关系](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/http1s和http关系.jpeg)

#### 过程


![https](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter06/http1s.jpeg)


1. 首先客户端通过URL访问服务器建立SSL连接。
2. 采用HTTPS的服务器要有一套CA证书，颁发证书的时候会产生私钥和公钥，私钥保存在服务端，不能泄露，公钥附带在证书信息中。
3. 服务端收到客户端请求后，会将网站支持的证书信息（证书中包含公钥）传送一份给客户端。
4. 客户端解析证书并对其验证，如果证书没问题，客户端就会从服务器证书中取出服务器的公钥A，然后客户端还会生成一个随机码KEY，并用公钥A加密
5. 客户端把加密后的随机码KEY发送给服务器，作为后面对称加密的密钥
6. 服务器在收到随机码KEY之后使用私钥对其解密，经过以上步骤建立了安全链接，并解决了密钥泄露
7. 服务器使用密钥key对数据进行对称加密，客户端使用key对称解密
8. 正常通信

#### 问题

申请证书成本，耗电，耗时间，其他的缺点说不明白不要说：中间人攻击，服务器劫持等






