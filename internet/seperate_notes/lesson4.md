# 第四章 网络层

## 概述

主要任务是把分组从远端传到目的段，为分组交换网上的不同主机提供通信服务。

网络层的传输单位是数据报。

+ 功能一：路由选择与分组转发：寻找最佳路径

+ 功能二：异构网络互联

+ 功能三：拥塞控制
：如果所有节点都来不及接受分组，而要丢弃大量分组的话，网络就处于拥塞状态，因此需要采取一定措施缓解这种拥塞。

    * 开环控制（静态）
    * 闭环控制（动态）

### 数据交换方式

如何使数据通过网络核心**路由器**从源主机到目的主机？————数据交换

### 为什么要数据交换？

### 数据交换方式

电路交换，报文交换，分组交换。分组交换又分数据报方式和虚电路方式

+ **电路交换**：例如电话网络

    * 建立连接（呼叫/电路建立） -> 通信 -> 释放连接（拆除电路）

    * 特点：独占资源

    * 优点：通信时延小，有序传输，没有冲突，实时性强

    * 缺点：建立连接时间长，线路独占，灵活性差，无差错控制能力

+ **报文交换**

    * 什么是报文：源应用发送的信息实体

    * 优点：不需要先建立连接；存储转发；动态分配线路；线路可靠性较高；线路利用率较高；多目标服务（指一个报文可以向多个目标传送）

    * 缺点：有存储转发时延；报文大小不定，需要网络节点有较大缓存空间。

+ **分组交换**

    * 把大的数据块分割成小的数据块。

    * 优点：无需建立连接；存储转发，动态分配线路；线路可靠性较高；线路利用率较高；相对于报文交换，存储管理更容易

    * 缺点：有存储转发时延；徐传输额外的信息量（每个报文都要有编号，头等）；乱序到达目的主机时，要对分组排序重组。

+ 报文交换和分组交换比较：

![报文交换分组交换比较](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/报文交换分组交换比较.JPG)


+ 三种数据交换方式比较总结

    ![三种数据报交换比较](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/三种数据报交换比较.JPG)


    1. 报文交换和分组交换都采用存储转发

    2. 传送数据量大，且传送时间远大于呼叫时，选择电路交换。电路交换传输时延最小。

    3. 从信道利用率来看，报文交换和分组交换优于电路交换，其中分组交换时延更小

+ 分组交换的**数据报方式**和**虚电路方式**

    * **数据报方式**为网络层提供无连接服务。无连接服务：不事先为分组的传输确定传输路径，每个分组独立确定传输路径，不同分组传输路径可能不同。

    * **虚电路方式**为网络层提供连接服务。有连接服务：首先为分组的传输确定传输路径（建立连接），然后沿该路径（连接）传输系列分组，系列分组传输路径相同，传输结束后拆除连接。

### 几种传输单元名词辨析

|  层 | 传输单元 |
|  ---- | ----  |
|  应用层  | 报文  |
|  传输层 | 报文段  |
| 网络层  | IP数据报，分组 |
| 数据链路层  | 帧 |
| 物理层  | 比特流 |

### 数据报（因特网使用）

无连接。

每一个分组携带源和目的地址

路由器根据分组的目的地址转发分组：基于路由协议/算法 构建转发表；检索转发表，每个分组独立选路

转发表，最基础的两列：目的网络地址，链路接口

### 虚电路

虚电路方式将数据报方式和电路交换方式结合，以发挥两者优点。
虚电路：一条源主机到目的主机类似于电路的路径（逻辑连接），
路径上所有的节点都要维持这条虚电路的建立，都维持一张虚电路表，
每一项记录了一个打开的虚电路的信息。

通信过程：

1. 建立连接（虚电路建立）：每个分组携带虚电路号，而非目的地址。源主机发送“呼叫请求“ 分组并收到“呼叫应答”分组后才算建立连接。

2. 数据传输：全双工通信

3. 释放连接（虚电路释放）：源主机发送“释放请求”分组 以拆除虚电路

### 数据报和虚电路比较

![数据报和虚电路](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/数据报和虚电路.JPG)

## IP数据报格式

### TCP/IP协议栈

TCP/IP协议栈的位置（橙色）

![TCP/IP协议栈](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/tcpip协议栈.JPG)

数据部分由运输层

![IPv4数据报格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/ipv4数据报格式.JPG)

固定部分为20字节固定长度

![IP数据报格式固定格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/IP数据报格式固定格式.JPG)

1. 版本：IPv4 or IPv6?

2. 首部长度：单位是4B，最小为5

3. 区分服务：指示期望获得那种类型的服务

4. 总长度：首部+数据长度，单位是1B

5. 生存时间（TTL）：IP分组的保质期，经过一个路由器-1，变成0则丢弃，防止未交付的数据报无线在链路上传输

6. 协议：数据部分的协议

![协议名字段值](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/协议名字段值.JPG)

7. 首部检验和：只检验首部，注意经过每个路由器都要更新一下，因为生存时间，片偏移会发生变化

8. 源地址和目的地址，32位，现在的IPv4的地址长度

9. 可选字段：0-40B，用来支持排错、测量以及安全等措施

10. 填充：全0，把首部补成4B的整数倍

## IP数据报分片

最大传送单元MTU：链路层**数据帧**可封装数据的上限。

以太网的MTU是1500字节

![最大传送单元MTU](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/最大传送单元MTU.JPG)

如果所传诵的数据报长度超过某链路的MTU值怎么办？————分片

11. 标识：统一数据报的不同分片使用同一标识

12. 标志：有三位但是只有两位有意义

    中间位DF（Dont Fragment)，DF=1禁止分片；DF=0允许分片

    最低位MF（More Fragment），MF=1，后面“还有分片”；MF=0，代表最后一片/）没有分片

13. 片偏移：指出较长分组分片后，某片在原分组中的相对位置，以8B为单位。

除了最后一个分片，每个分片长度一定是8B的整数倍。

### 例题

## IPv4地址

**IP地址：** 目的主机在哪个网络？哪个主机？
    全世界唯一的32位/4字节标识符，标识路由器主机的接口。IP地址::=网络号主机号（用另一个电脑修改一下，mac打不出来

### 分类的IP地址

（图片

以及特殊IP地址

（图片

因此有

以上这些都是”本网范围内“的私有IP地址

## 网络地址转换（NAT）

路由器对目的地址是私有IP地址的数据报一律不进行转发

网络地址转换NAT：在专用网连接到因特网的路由器上安装NAT软件，
安装了NAT软件的路由器叫NAT路由器，他至少有一个有效的外部全球IP地址。

（图片）

## 子网划分和子网掩码

分类的IP地址的弱点：

1. IP地址空间的利用率有时候很低

2. 两级IP地址不够灵活

图片（

两级IP地址->三级IP地址：某单位划分子网后，对外仍表现为一个网络，即本单位外的网络看不见本单位子网的划分。

子网掩码：

二级IP地址的子网掩码：只要是网络号都是1，主机号都是0；即255.255.0.0
（图片

三级，子网号部分也是全1。子网掩码与IP地址逐位相与，就得到子网网络地址。

子网掩码是用来确定有多少位是子网，多少位之后是主机号的。

## 使用子网时分组的转发

路由表中：

+ 目的网络地址

+ 目的网络子网掩码

+ 下一跳地址 

路由器转发分组的算法：

1. 提取目的IP地址

2. 是否直接交付

3. 特定主机路由

4. 检测路由表中有无路径

5. 默认路由0.0.0.0

6. 丢弃，报告转发分组错误

## 无分类编址CIDR

1. 消除了传统的A类，B类和C类地址以及划分子网的概念。
CIDR记法：IP地址后加上”/“，然后写上网络前缀，可以任意长度，的位置

（图片

2. 融合子网地址与子网掩码，方便子网划分。
CIDR把网络前缀相同的连续的IP地址组成一个”CIDR地址块“。
如：128.14.35.7/20是某CIDR地址块中的一个地址。
即：把128.14.35.7写成32位二进制，前二十位都是网络前缀。

（图片列成表格

### 构成超网

将多个子网聚合成一个较大的子网，叫做构成超网。或路由聚合。方法是将网络前缀缩短。



**最长前缀匹配**：使用CIDR时，查找路由表可能得到几个匹配结果，应选择**具有最长网络前缀**的路由。前缀越长，地址块越小，路由越具体。

（例题，写表格）
路由器R0的路由表见下表：若进入路由器R0的分组的目的地址是132.19.237.5,请问该分组应被转发到哪个下一跳路由器？ R2,(R3不匹配)

|  下一跳  |   目的网络  | 
|  ---- |  ---- | 
|   R1  |   132.0.0.0/8  | 
|   R2  |   132.0.0.0/11  | 
|   R3  |   132.19.232.0/22  | 
|   R4  |   0.0.0.0/8  | 

## ARP协议

由于在实际网络的链路上传送数据帧时，最终必须使用MAC地址。ARP协议：完成主机或路由器IP地址到MAC地址的映射。

ARP协议的使用过程：检查ARP高速缓存，有对应表项


## DHCP协议

## ICMP报文

ICMP协议支持主机或路由器：差错（或异常）报告，网络探询

### ICMP差错报告报文

1. 终点不可达：当路由器或主机不能交付数据报时就向原点发送终点不可达报文。

2. 源点一直：当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，
使源点知道应当把数据报的发送速率放慢

3. 时间超过：当路由器收到生存时间TTL=0的数据报时，除了丢弃该数据报外，还要向源点发送时间超过报文。当重点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。

4. 参数问题：当路由器或目的主机收到的数据报首部中有的字段的值不正确时，就丢弃该数据报。并向原点发送参数问题报文。

5. 改变路由（重定向）：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器。

（图片：ICMP差错报告报文数据字段

不应发送ICMP差错报文的情况

1. 对ICMP差错报告报文不再发送ICMP差错报告报文

2. 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报文

3. 对具有组播地址的数据报都不发送ICMP差错报告报文

4. 对具有特殊地址的数据报（本网络内的本主机地址0.0.0.0，环回地址127.0.0.0）都不发送ICMP差错报告报文

### ICMP询问报文

1. 回送请求和回答报文：主机或路由器向特定目的主机发送的询问（PING），收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。

2. 时间戳请求和回答报文：请某个主机或路由器回答当前的日期和时间，用来进行时钟同步和测量时间

3. 掩码地址请求和回答报文

4. 路由器询问和通告报文：3，4都不再使用

### ICMP的应用

PING：测试两个主机之间的连通性，使用了ICMP回送请求和回答报文

Traceroute：跟踪一个分组从源点到终点的路径，使用了ICMP时间超过差错报告报文。

把TTL依次设置为1，2，3...，就可以测算出终点到源点的距离


## IPv6

32位IPv4空间已经分配殆尽，采用CIDR和NAT，但是没有太大改善，
于是使用IPv6，从根本上解决了地址耗尽的问题。

IPv6改进了首部格式，加快路由器处理速度，转发数据报速度

支持QoS：Quality of Service，指一个网络能利用各种基础技术，
为指定的网络通信提供更好的服务能力，是一种安全机制，
用来解决网络延迟和阻塞的一种技术

### IPv6的数据报格式

固定40B首部：

![IPv6数据报格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/ipv6数据报格式.JPG)

+ 版本：指明了协议版本，总是6

+ 优先级：区分数据报的类别和优先级

+ 流标签：“流”是指互联网上从特定源点到特定终点的一系列数据报，所有属于同一个流的数据报都属于同一个流标签。

+ 有效载荷长度：指扩展首部/数据的长度

+ 下一个首部：表示下一个扩展首部或者上层协议首部

+ 跳数限制：相当于IPv4的TTL

+ 源地址和目的地址都变成了128位，IPv4是32位

### IPv6和IPv4的区别

1. IPv6将地址从32位（4B）扩展到了128位（16B），更大的地址空间。

2. IPv6移除了校验和字段，以减少每一跳的处理时间

3. IPv6将IPv4的可选字段移出了首部，放入扩展首部，成为更灵活的首部格式，路由器通常不对扩展首部进行检查，提高了路由器处理效率

4. IPv6支持即插即用，不需要**DHCP协议**

5. IPv6首部长度必须是8B整数倍，IPv4首部是4B的整数倍。

6. IPv6只能在主机处分辨，IPv4可以在路由器和主机处分片

7. ICMPv6:附加报文类型”分组过大“

8. IPv6支持资源的与分配，支持实时视像等要求，保证一定的带宽和时延的应用，

9. IPv6取消了协议字段，改为”下一个首部“字段

10. IPv6取消了总长度字段，改为有效载荷长度的字段

11. IPv6取消了服务类型字段

### IPv6的地址表示形式

+ 冒号十六进制记法：4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170

+ 压缩形式：把0000写成0
    
    零压缩：一连串连续的0可以被一对冒号取代，但双冒号法在一个地址中仅可出现一次，如：FF05:0:0:0:0:0:0:B3 -> FF05::B3

### IPv6基本地址类型

+ 单播：一对一通信，可做源地址+目的地址

+ 多播：一对多通信，可做目的地址

+ 任播：一对多当中的一个通信，可做目的地址

### IPv4向IPv6的过渡策略

+ 双栈协议：在一台设备上同时启用IPv4和IPv6协议栈

+ 隧道技术：隧道协议将其他协议的数据帧或包重新封装然后通过隧道发送

## 路由算法以及路由协议

![路由算法1](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/路由算法1.JPG)

路由表/转发表中的表项是由那里得到的呢？路由算法

最佳路由：“最佳”只是相对于某一种特定要求下得出的较为合理的选择。


路由算法：
+ 静态路由算法（非自适应的路由算法）：管理员手工配置路由信息。

    简便、可靠，在负荷稳定，拓扑变化不大的网络中运行效果很好，
广泛用于高度安全性的军事网络和娇小的商业网络。

    路由更新慢，不适用于大型网络。


+ 动态路由算法（自适应的路由算法）：路由器间彼此交换信息，按照路由算法 优化出 路由表项。

    路由更新快，适用于大型网络，及时响应链路费用或网络拓扑变化。

    算法复杂，增加网络负担。

动态路由算法：

+ 全局性：链路状态路由算法OSPF：所有路由器掌握完整的网络拓扑和链路费用信息。

+ 分散性：距离向量路由算法RIP：路由器只掌握物理相连的邻居及链路费用。

分层次的路由选择协议

+ 因特网规模很大

1. 因特网规模很大

2. 许多单位不想让外界知道自己的路由选择协议，但还想连入因特网

    自治系统AS：（图片补文字


![AS1](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/AS1.JPG)


![AS2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/AS2.JPG)

![AS3](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/AS3.JPG)


## RIP协议和距离向量算法

回顾：

![AS2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/AS2.jpeg)

RIP协议是一种分布式的，基于距离向量的路由选择协议，是因特网的协议标准，最大优点是简单。

RIP协议要求网络中**每一个路由器**都维护从它自己到其他**每一个目的网络**的唯一最佳距离纪录（跳数）

例子：R2的路由表


![R2的路由表](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/R2的路由表.jpeg)

距离通常指“跳数”，即从源端口到目的端口所经过的路由器个数，经过一个路由器跳数+1，特别的，从一路由器到直接连接的网络距离为1。RIP允许一条路由最多只能包含15个路由器，因此距离为**16表示网络不可达**。

因此RIP只适用于小互联网。

路由表是如何建立的？即和其他路由器交换信息。问题

+ RIP协议和谁交换：仅和相邻路由器交换信息
    
+ 交换什么：路由器交换的是自己的路由表

+ 多久交换一次：每30s交换一次路由信息，然后路由器根据新信息更新路由表，
若超过180没有收到邻居路由器的通告，则判定邻居没了并更新自己的路由表

    路由器刚开始工作时，只知道直接连接的网络距离（为1），
接着每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。

    若干次更新后所有路由器将会知道到达本自治系统任何一个网络的最短距离和下一跳路由器的地址

由距离向量算法更新

1. 修改相邻路由器发来的RIP报文中所有表项

    对地址为X的相邻路由器发来的报文，修改此报文中所有项目：
    把“下一跳”字段中的地址改为X，并把所有的“距离”字段+1.

2. 


3. 

4. 返回

图片，补文字

![距离向量算法](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/距离向量算法.jpeg)


RIP协议报文格式

![RIP协议报文格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/RIP协议报文格式.jpeg)

RIP是应用层协议，使用UDP传送数据

一个RIP报文最多可以包括25个路由，如果超过，必须在用一个RIP报文发送

RIP协议：好消息传得快，坏消息传的慢，
即网络出现故障时需要经过比较长的时间才能将此信息传送到所有的路由器。“慢收敛”。

## OSPF协议及链路状态算法

**开放最短路径优先OSPF协议：** 开放是指公开发表的，不受某厂商控制。
最短路径优先指使用Dijistra提出的最短路径算法SPF。

OSPF最主要特征是使用分布式的链路状态协议

问题：

+ 和谁交换：使用洪范算法像自治系统内所有路由器发送信息，即路由器通过输出端口向所有相邻的路由器发送信息，而每一个相邻路由器又再次将此信息发往其所有的相邻路由器。”广播“

+ 交换什么：发送的信息就是与本路由器相邻的所有路由器的链路状态。（本路由器和哪些路由器相邻，以及该链路的度量/代价，如费用、距离、时延、带宽等）

+ 多久交换：只有当链路状态发生变化时，路由器才向所有路由器洪范发送此信息。

    最后，所有路由器都能建立一个链路状态数据库，即全网拓扑图

链路状态路由算法

（补一下文字

![链路状态路由算法](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/链路状态路由算法.jpeg)

7. 使用Dijkstra根据自己的链路状态数据库构造到其他节点间的最短路径。

### OSPF的区域

![OSPF的区域](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/OSPF的区域.JPG)

### OSPF分组

OSPF分组用IP数据报传送，RIP是用UDP

![OSPF分组](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/OSPF分组.JPG)

### 其他特点

1. 每隔30min，要刷新一次数据库中的链路状态

2. 由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此当互联网规模很大时，OSPF协议要比距离向量协议RIP好很多。

3. OSPF不存在坏消息传递慢的问题，收敛速度快


## BGP协议

问题：

![BGP结构](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/BGP结构.jpeg)


+ 和谁交换？与其他的AS的邻站BGP发言人交换信息。

+ 交换什么？交换的网络可达性的信息，即要到达某个网络所要经过的一系列AS

+ 多久交换？发生变化时更新有变化的部分。

BGP交换的网络**可达性的信息**就是要到达某一个网络所要经过的一系列AS。
当BGP发言人互相交换了网络可达性的信息之后，
各个BGP发言人就根据所采用的策略从收到的路由信息中找出到达各个AS的较好路由

AS：自治系统

### BGP协议交换信息的过程

BGP发言人交换路径向量：

![BGP协议交换信息的过程1](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/BGP协议交换信息的过程1.JPG)

![BGP协议交换信息的过程2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/BGP协议交换信息的过程2.JPG)


### BGP协议报文格式

BGP是一个应用层协议

![BGP协议报文格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/BGP协议报文格式.JPG)

### BGP协议特点

支持CIDR，因此BGP的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所哟经过的各个自治系统的序列。在BGP刚刚运行时，BGP的邻站是交换整个BGP路由表，但是以后只需要在发生变化时更新有变化的部分，节省网络带宽和减少路由器的处理开销。

### BGP的四种报文

1. OPEN报文：用来与相邻的另一个BGP发言人建立关系，并认证发送方。

2. UPDATE报文：通告新路径或撤销原路径

3. KEEPALIVE报文：在无UPDATE时，周期性证实邻站的联通性，也作为OPEN的确认。

4. NOTIFICATION报文：报告先前报文的差错，也被用于关闭连接。

### 三种路由协议比较

1. RIP：一种分布式的基于距离向量的内部网关路由选择协议，通过广播UDP报文来交换路由信息。

2. OSPF：是一个内部网关协议，要交换的信息量较大，应使报文的长度尽量短，所以不是用传输层协议，而是直接采用IP

3. BGP是一个外部网关协议，在不同的自治系统之间交换路由信息，由于网络环境复杂，需要保证可靠传输，所以采用TCP

![三种路由协议比较](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/三种路由协议比较.JPG)

## IP组播

IP数据报的三种传输方式：单播，广播，组播（多播）

* 单播：单播用于发送数据包到单个目的地，且每发送一份单播报文都使用一个单播IP地址作为目的地址，是一种点对点传送方式。

* 广播：广播是指发送数据包到同一广播域或子网内的所有设备的一种数据传输方式，是一种点对多点的传输方式

* 组播（多播）：点对多点的传播方式

![组播多播](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/组播多播.jpeg)


单播，组播示意图


### IP组播地址

IP组播地址让源设备能够将分组发送给一组设备，
属于多播组的设备将被分配一个组播组IP地址（一群共同需求主机的相同标识）。

组播地址范围是224.0.0.0 - 239.255.255.255（D类地址）

1. 组播数据报也是“尽最大努力交付”，不提供可靠交付，应用于UDP

2. 对组播数据报不产生ICMP差错报文

3. 并非所有D类地址都可以作为组播地址。有些地址已经被指派为永久组播地址

## 移动IP

### 移动IP概念

![移动IP概念](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/移动IP概念.jpeg)


### 移动IP通信过程

![移动IP通信过程](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/移动IP通信过程.jpeg)

3. 外部代理拆封数据报并发给A

A移动到了下一个网络

![移动IP通信过程2](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/移动IP通信过程2.jpeg)

## 网络层设备

路由器：是一种具有多个输入端口和多个输出端口的专用计算机，其任务是转发分组

**路由器结构：**

![路由器结构](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/路由器结构.jpeg)

**路由选择：** 根据所选定的路由选择协议构造出路由表，同时经常或定期的与相邻路由器交换路由信息而不断的更新和维护路由表。

**分组转发：** 交换结构：根据转发表（路由表得来）对分组进行转发。转发vs路由选择：

输入端口对线路上收到分组的处理

![输入端口对线路上收到分组的处理](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/输入端口对线路上收到分组的处理.jpeg)

输出端口对线路上收到分组的处理

![输出端口对线路上收到分组的处理](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/输出端口对线路上收到分组的处理.jpeg)

若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃

路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因。


### 三层设备的区别


![三层设备的区别](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/三层设备的区别.jpeg)

### 路由表和路由转发

路由表是根据路由选择算法得出的，主要作用是路由选择，总用软件来实现

默认路由

路由转发是

![路由表和路由转发](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/路由表和路由转发.jpeg)



